apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-reporting-legacy-api-config
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
data: null
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
rules:
  - apiGroups:
      - mojaloop.io
    resources:
      - mojaloopreports
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - mojaloop.io
    resources:
      - mojaloopreports/status
    verbs:
      - get
      - list
      - watch
      - create
      - update
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: release-name-reporting-legacy-api
subjects:
  - kind: ServiceAccount
    name: release-name-reporting-legacy-api
    namespace: default
---
apiVersion: v1
kind: Service
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 3000
      protocol: TCP
  selector:
    app.kubernetes.io/name: reporting-legacy-api
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/component: reporting-legacy-api
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: reporting-legacy-api
      app.kubernetes.io/instance: release-name
      app.kubernetes.io/component: reporting-legacy-api
  template:
    metadata:
      annotations:
        checksum/config: c8b92ffc5d609d8aa5b7094c9ba8e37bb090d1f519d4ae145b2067fc4550ca3b
        prometheus.io/port: "3000"
        prometheus.io/scrape: "true"
      labels:
        app.kubernetes.io/name: reporting-legacy-api
        helm.sh/chart: reporting-legacy-api-2.0.3
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: reporting-legacy-api
        app.kubernetes.io/version: 2.0.3
    spec:
      serviceAccountName: release-name-reporting-legacy-api
      affinity:
        podAffinity: null
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: reporting-legacy-api
                    app.kubernetes.io/instance: release-name
                    app.kubernetes.io/component: reporting-legacy-api
                namespaces:
                  - default
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity: null
      securityContext:
        fsGroup: 1001
      initContainers: null
      containers:
        - name: reporting-legacy-api
          image: docker.io/mojaloop/reporting:v11.0.0
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 11586
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                "": NET_RAW
            readOnlyRootFilesystem: true
          command:
            - npm
            - start
          ports:
            - name: http
              containerPort: 3000
          env:
            - name: DB_HOST
              value: centralledger-mysql
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              value: central_ledger
            - name: DB_USER
              value: central_ledger
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: centralledger-mysql
                  key: mysql-password
            - name: WATCH_RESOURCE_GROUP
              value: mojaloop.io
            - name: WATCH_RESOURCE_VERSION
              value: v1
            - name: WATCH_RESOURCE_PLURAL
              value: mojaloopreports
            - name: WATCH_NAMESPACE
              value: default
            - name: VALIDATION_RETRY_COUNT
              value: "10"
            - name: VALIDATION_RETRY_INTERVAL_MS
              value: "5000"
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: release-name-reporting-legacy-api
  namespace: 57jYphF
  labels:
    app.kubernetes.io/name: reporting-legacy-api
    helm.sh/chart: reporting-legacy-api-2.0.3
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: reporting-legacy-api
spec:
  rules:
    - host: reporting-legacy-api.local
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: release-name-reporting-legacy-api
                port:
                  name: http
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-dfsp-settlement
spec:
  permission: report-dfsp-settlement
  endpoint:
    path: /dfspSettlement
    params:
      - name: settlementId
        required: true
      - name: dfspId
        required: true
  queries:
    - name: dfspInfo
      query: |
        SELECT participantId, name FROM participant WHERE name = :dfspId AND name != 'Hub'
    - name: report
      query: |
        SELECT settlementId,
               settlementWindowId,
               p.participantId,
               p.name,
               currencyId,
               currencyScale,
               sentAmount,
               sentVolume,
               receivedAmount,
               receivedVolume,
               (sentAmount + receivedAmount) as totalAmount,
               (sentVolume + receivedVolume) as totalVolume,
               receivedAmount - sentAmount as netAmount,
               s3.createdDate,
                lastActionDate
        FROM participant p INNER JOIN
             (
                 SELECT settlementId,
                        settlementWindowId,
                        MAX(currencyId) as currencyId,
                        MAX(currencyScale) as currencyScale,
                        participantId,
                        SUM(sentAmount)     as sentAmount,
                        SUM(sentVolume)     as sentVolume,
                        SUM(receivedAmount) as receivedAmount,
                        SUM(receivedVolume) as receivedVolume,
                        MAX(createdDate) as createdDate,
                        MAX(lastActionDate) as lastActionDate
                 FROM (
                          SELECT settlementId,
                                 settlementWindowId,
                                 MAX(createdDate) as createdDate,
                                 MAX(lastActionDate) as lastActionDate,
                                 MAX(currencyId) as currencyId,
                                 MAX(currencyScale) as currencyScale,
                                 IF(senderName != :dfspId, senderId, receiverId) as participantId,
                                 SUM(IF(senderName = :dfspId, amount, 0))       as sentAmount,
                                 SUM(IF(senderName = :dfspId, volume, 0))       as sentVolume,
                                 SUM(IF(receiverName = :dfspId, amount, 0))     as receivedAmount,
                                 SUM(IF(receiverName = :dfspId, volume, 0))     as receivedVolume
                          FROM (
                                   SELECT MAX(CASE WHEN tP.amount > 0 THEN p.participantId END) as senderId,
                                          MAX(CASE WHEN tP.amount < 0 THEN p.participantId END) as receiverId,
                                          MAX(CASE WHEN tP.amount > 0 THEN p.name END)          as senderName,
                                          MAX(CASE WHEN tP.amount < 0 THEN p.name END)          as receiverName,
                                          MAX(tP.amount)                                        as amount,
                                          MAX(c.currencyId)                                     as currencyId,
                                          MAX(c.scale)                                          as currencyScale,
                                          COUNT(DISTINCT (tF.transferId))                       as volume,
                                          s.settlementId,
                                          sSW.settlementWindowId,
                                          MAX(s.createdDate) as createdDate,
                                          MAX(tF.completedDate)                        as lastActionDate
                                   FROM transferParticipant tP
                                            INNER JOIN transferFulfilment tF on tP.transferId = tF.transferId
                                            INNER JOIN settlementSettlementWindow sSW
                                                       on tF.settlementWindowId = sSW.settlementWindowId
                                            INNER JOIN settlementWindowStateChange sWSC
                                                       on sSW.settlementWindowId = sWSC.settlementWindowId
                                            INNER JOIN settlement s on sSW.settlementId = s.settlementId
                                            INNER JOIN participantCurrency pC
                                                       on tP.participantCurrencyId = pC.participantCurrencyId
                                            INNER JOIN currency c on c.currencyId = pC.currencyId
                                            INNER JOIN participant p on pC.participantId = p.participantId
                                   WHERE tF.isValid
                                     AND sWSC.settlementWindowStateId = 'CLOSED'
                                     AND s.settlementId = :settlementId
                                   GROUP BY tF.transferId, s.settlementId
                               ) s
                          WHERE s.senderName = :dfspId
                             OR s.receiverName = :dfspId
                          GROUP BY settlementId, settlementWindowId, senderId, receiverId, senderName, receiverName
                      ) s2

                 GROUP BY settlementId, settlementWindowId, participantId
             ) s3 ON p.participantId = s3.participantId
        WHERE p.name != 'Hub'
        ORDER BY p.name, settlementWindowId
  template: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <style>
            table {
                font-family: Calibri;
                font-size: 11pt;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th {
                border: 1px solid black;
                text-align: left;
                padding: 8px;
            }

            td {
                border: 1px solid black;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
            tr.noborder td {
                border: none;
            }
        </style>
        <title>FSP Settlement Report</title>
    </head>
    <body>

    <%
    const formatAmount = (amount, currency, scale) => {
      const v = parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: scale });
      return `${v} ${currency}`;
    }
    const formatNetPosition = (amount, currency, scale) => {
        const v = parseFloat(amount);
        const vf = Math.abs(v).toLocaleString('en-US', { minimumFractionDigits: scale });
        return v >= 0 ? `${vf} ${currency}` : `(${vf}) ${currency}`;
    }
    %>

    <table data-json="<%= JSON.stringify(report) %>" data-sheet-name="DFSPSettlementReport">
        <tr>
            <td><span>Report for:</span></td>
            <td><span>FSP ID</span></td>
            <td><%= dfspInfo[0]?.name %></td>
            <td><span>Settlement ID</span></td>
            <td style="text-align: right"><%= report[0]?.settlementId %></td>
            <td></td>
            <td></td>
            <td><span>Created Date</span></td>
            <td colspan="2" style="text-align: right"><%= report[0] && (d = report[0].createdDate, `${d.toLocaleDateString('en-ZA')} ${d.toLocaleTimeString('en-US')}`)%></td>
        </tr>
        <tr class = "noborder">
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td style="border: 1px solid black"><span>Last Action Date</span></td>
            <td colspan="2" style="text-align: right;border: 1px solid black"><%=
                report[0] &&
                (d = report
                        .filter(a => a.lastActionDate)
                        .reduce((a,b) => a.lastActionDate.getTime() > b.lastActionDate.getTime() ? a : b).lastActionDate,
                        `${d.toLocaleDateString('en-ZA')} ${d.toLocaleTimeString('en-US')}`)
                %></td>
        </tr>
        <tr class = "noborder">
            <td colspan="100%" style="padding-top: 20px"></td>
        </tr>
        <tr>
            <th>Window ID</th>
            <th>FSP ID</th>
            <th>Sent to FSP</th>
            <th></th>
            <th>Received from FSP</th>
            <th></th>
            <th>Total</th>
            <th>Total Value of All Transactions</th>
            <th>Net Position vs. Each DFSP</th>
        </tr>
        <tr>
            <th></th>
            <th></th>
            <th>Volume</th>
            <th>Value</th>
            <th>Volume</th>
            <th>Value</th>
            <th>Volume</th>
            <th></th>
            <th></th>
        </tr>
        <% for(let entry of report) { %>
            <tr style="text-align: right">
                <td><%= entry.settlementWindowId %></td>
                <td style="text-align: left"><%= entry.name %></td>
                <td><%= entry.sentVolume %></td>
                <td><%= formatAmount(entry.sentAmount, entry.currencyId, entry.currencyScale) %></td>
                <td><%= entry.receivedVolume %></td>
                <td><%= formatAmount(entry.receivedAmount, entry.currencyId, entry.currencyScale) %></td>
                <td><%= entry.totalVolume %></td>
                <td><%= formatAmount(entry.totalAmount, entry.currencyId, entry.currencyScale) %></td>
                <td><%= formatNetPosition(entry.netAmount, entry.currencyId, entry.currencyScale) %></td>
            </tr>
        <% } %>

        <tr>
            <td colspan="8" style="padding-top: 15px"><span>Aggregated Net Positions</span></td>
            <td style="text-align: right"><%= report[0] && formatNetPosition(report.reduce((a, b) => a + (parseFloat(b.netAmount) || 0), 0), report[0]?.currencyId, report[0]?.currencyScale) %></td>
        </tr>
    </table>
    </body>
    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-dfsp-settlement-detail
spec:
  permission: report-dfsp-settlement-detail
  endpoint:
    path: /dfspSettlementDetail
    params:
      - name: settlementId
        required: true
      - name: fspid
        required: true
  queries:
    - name: dfspInfo
      query: |
        SELECT participantId, name FROM participant WHERE name = :fspid AND name != 'Hub'
    - name: report
      query: |
        SELECT
                pCPayer.participantId as payerFspid,
                pPayer.name as payerFspName,
                pCPayee.participantId as payeeFspid,
                pPayee.name as payeeFspName,
                tF.transferId,
                tS.name as transactionType,
                tSS.name as transactionNature,
                tF.completedDate as lastModifiedDate,
                pITPayer.name as payerIdentifierType,
                qpPayer.partyIdentifierValue as payerIdentifierValue,
                pITPayee.name as payeeIdentifierType,
                qpPayee.partyIdentifierValue as payeeIdentifierValue,
                IF(pPayee.name = :fspid, t.amount, 0) as receivedAmount,
                IF(pPayer.name = :fspid, t.amount, 0) as sentAmount,
                c.currencyId,
                s.settlementId,
                s.createdDate as settlementCreatedDate,
                sSW.settlementWindowId
            FROM
                transferFulfilment tF
                INNER JOIN transfer t ON t.transferId = tF.transferId
                INNER JOIN transferParticipant tPPayer ON tPPayer.transferId = tF.transferId
                    AND tPPayer.transferParticipantRoleTypeId = (SELECT transferParticipantRoleTypeId from transferParticipantRoleType WHERE name = 'PAYER_DFSP')
                    INNER JOIN participantCurrency pCPayer ON pCPayer.participantCurrencyId = tPPayer.participantCurrencyId
                    INNER JOIN participant pPayer ON pPayer.participantId = pCPayer.participantId
                INNER JOIN transferParticipant tPPayee ON tPPayee.transferId = tF.transferId
                    AND tPPayee.transferParticipantRoleTypeId = (SELECT transferParticipantRoleTypeId from transferParticipantRoleType WHERE name = 'PAYEE_DFSP')
                    INNER JOIN participantCurrency pCPayee ON pCPayee.participantCurrencyId = tPPayee.participantCurrencyId
                    INNER JOIN participant pPayee ON pPayee.participantId = pCPayee.participantId
                INNER JOIN settlementWindow sW on sW.settlementWindowId = tF.settlementWindowId
                INNER JOIN settlementSettlementWindow sSW on tF.settlementWindowId = sSW.settlementWindowId
                INNER JOIN settlementWindowStateChange sWSC on sW.currentStateChangeId = sWSC.settlementWindowStateChangeId
                INNER JOIN settlement s on sSW.settlementId = s.settlementId
                INNER JOIN settlementModel sM ON sM.settlementModelId = s.settlementModelId
                INNER JOIN currency c ON c.currencyId = sM.currencyId
                INNER JOIN quote q on q.transactionReferenceId = tF.transferId
                INNER JOIN quoteParty qpPayer on qpPayer.quoteId = q.quoteId AND qpPayer.partyTypeId = (SELECT partyTypeId FROM partyType WHERE name = 'PAYER')
                    INNER JOIN partyIdentifierType pITPayer ON pITPayer.partyIdentifierTypeId = qpPayer.partyIdentifierTypeId
                INNER JOIN quoteParty qpPayee on qpPayee.quoteId = q.quoteId AND qpPayee.partyTypeId = (SELECT partyTypeId FROM partyType WHERE name = 'PAYEE')
                    INNER JOIN partyIdentifierType pITPayee ON pITPayee.partyIdentifierTypeId = qpPayee.partyIdentifierTypeId
                INNER JOIN transactionScenario tS on tS.transactionScenarioId = q.transactionScenarioId
                LEFT JOIN transactionSubScenario tSS on tSS.transactionSubScenarioId = q.transactionSubScenarioId
            WHERE
                tF.isValid
                AND s.settlementId = :settlementId
                AND (pPayee.name = :fspid OR pPayer.name = :fspid)
  template: "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <style>\n        table {\n            font-family: Calibri;\n            font-size: 11pt;\n            border-collapse: collapse;\n            width: 100%;\n            display: block;\n            overflow-x: auto;\n            white-space: nowrap;\n        }\n        th {\n        //            border: 1px solid #efefef;\n            text-align: left;\n            padding: 0 8px;\n        }\n\n        td {\n            border: 1px solid black;\n            padding: 8px;\n        }\n\n        tr:nth-child(even) {\n//            background-color: #efefef;\n        }\n\n        td > span {\n            font-weight: bold;\n        }\n        tr.noborder td {\n            border: none;\n        }            \n    </style>\n    <title>FSP Settlement Report</title>\n</head>\n<body>\n\n<%\n    const formatAmount = (amount) => parseFloat(amount).toLocaleString('en-US');\n%>\n\n<table data-json=\"<%= JSON.stringify(report) %>\" data-sheet-name=\"DFSPSettlementDetailReport\">\n     <tr>\n        <td>Participant ID</td>\n        <td style=\"text-align: right\"><%= dfspInfo[0]?.participantId %></td>\n        <td>FSP ID</td>\n        <td style=\"text-align: right\"><%= dfspInfo[0]?.name %></td>\n        <td>Settlement ID</td>\n        <td style=\"text-align: right\"><%= report[0]?.settlementId %></td>\n        <td style=\"width: 20px\"></td>\n        <td>Created Date</td>\n        <td colspan=\"2\" style=\"text-align: right\"><%= report[0]?.settlementCreatedDate.toISOString() %></td>\n        <td style=\"wisth: 20px\"></td>\n        <td>Currency</td>\n        <td><%= report[0]?.currencyId %></td>\n    </tr>\n    <tr class = \"noborder\">\n        <td colspan=\"14\" style=\"padding-top: 20px\"></td>\n    </tr>\n    <tr>\n        <td>Sender Participant ID</td>\n        <td>Sender FSP ID</td>\n        <td>Receiver Participant ID</td>\n        <td>Receiver FSP ID</td>\n        <td>Transfer ID</td>\n        <td>Tx Type</td>\n        <td>Tx Nature</td>\n        <td>Last Modified</td>\n        <td>Sender ID Type</td>\n        <td>Sender ID</td>\n        <td>Receiver ID Type</td>\n        <td>Receiver ID</td>\n        <td>Received Amount</td>\n        <td>Sent Amount</td>\n        <td>Fee</td>\n    </tr>\n    <% for(let e of report) { %>\n        <tr>\n            <td><%= e.payerFspid %></td>\n            <td><%= e.payerFspName %></td>\n            <td><%= e.payeeFspid %></td>\n            <td><%= e.payeeFspName %></td>\n            <td><%= e.transferId %></td>\n            <td><%= e.transactionType %></td>\n            <td><%= e.transactionNature %></td>\n            <td><%= e.lastModifiedDate.toISOString() %></td>\n            <td><%= e.payerIdentifierType %></td>\n            <td><%= e.payerIdentifierValue %></td>\n            <td><%= e.payeeIdentifierType %></td>\n            <td><%= e.payeeIdentifierValue %></td>\n            <td><%= formatAmount(e.receivedAmount) %></td>\n            <td><%= formatAmount(e.sentAmount) %></td>\n            <td>-</td>\n        </tr>\n    <% } %>\n</table>\n</body>\n</html>\n"
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-dfsp-settlement-statement
spec:
  permission: report-dfsp-settlement-statement
  endpoint:
    path: /dfspSettlementStatement
    params:
      - name: dfspId
        required: true
      - name: startDate
        required: true
      - name: endDate
        required: true
  queries:
    - name: dfspInfo
      query: "SELECT \n    p.participantId, \n    p.name, \n    :startDate AS startDate, \n    :endDate AS endDate,\n    pc.currencyId,\n    pc.participantCurrencyId,\n    lat.name AS accountType\nFROM participant p\nINNER JOIN participantCurrency pc on pc.participantId = p.participantId\nINNER JOIN ledgerAccountType lat on lat.ledgerAccountTypeId = pc.ledgerAccountTypeId\nWHERE p.name = :dfspId AND p.name != 'Hub' AND lat.name = 'SETTLEMENT'\n"
    - name: report
      query: "SELECT participantId, name, currencyId, participantCurrencyId, transferId, createdDate, status, description, fundsIn, fundsOut, balance, currencyScale, accountType FROM (\n  SELECT\n    p.participantId AS participantId,\n    p.name AS name,\n    pc.currencyId AS currencyId,\n    pc.participantCurrencyId AS participantCurrencyId,\n    tp.transferId AS transferId, \n    tp.createdDate AS createdDate, \n    (CASE WHEN COALESCE(tsIn.enumeration, tsOut.enumeration) != 'ABORTED' THEN 'SUCCESS' ELSE tsOut.enumeration END) AS status,\n    COALESCE(tscIn.reason, tscOut.reason) AS description,\n    (CASE WHEN tp.amount < 0 THEN -tp.amount ELSE NULL END) AS fundsIn,\n    (CASE WHEN tp.amount > 0 THEN tp.amount ELSE NULL END) AS fundsOut,\n    ppc.value AS balance,\n    c.scale AS  currencyScale,\n    lat.name AS accountType\n  FROM participant p \n  INNER JOIN participantCurrency pc ON p.participantId = pc.participantId \n  INNER JOIN ledgerAccountType lat ON lat.ledgerAccountTypeId = pc.ledgerAccountTypeId\n  INNER JOIN transferParticipant tp ON tp.participantCurrencyId = pc.participantCurrencyId\n  INNER JOIN transferParticipantRoleType tpr ON tpr.transferParticipantRoleTypeId = tp.transferParticipantRoleTypeId  \n  LEFT JOIN transferStateChange tscOut ON tp.transferId = tscOut.transferId AND tscOut.transferStateChangeId = (SELECT MAX(transferStateChangeId) FROM transferStateChange tscOut1 WHERE tscOut1.transferId = tp.transferId\n    AND tscOut1.transferStateId in ('RESERVED', 'ABORTED_REJECTED'))\n  LEFT JOIN transferState tsOut ON tscOut.transferStateId = tsOut.transferStateId\n  LEFT JOIN transferStateChange tscIn ON tp.transferId = tscIn.transferId AND tscIn.transferStateChangeId = (SELECT MAX(transferStateChangeId) FROM transferStateChange tscIn1 WHERE tscIn1.transferId = tp.transferId\n    AND tscIn1.transferStateId in ('COMMITTED', 'ABORTED_REJECTED'))\n  LEFT JOIN transferState tsIn ON tscIn.transferStateId = tsIn.transferStateId\n  INNER JOIN participantPosition pp ON pp.participantCurrencyId = pc.participantCurrencyId\n  INNER JOIN participantPositionChange ppc ON ppc.participantPositionId = pp.participantPositionId\n  INNER JOIN currency c ON c.currencyId = pc.currencyId\n  WHERE tpr.name = 'DFSP_SETTLEMENT' \n  AND p.name = :dfspId\n  AND (tscIn.transferStateChangeId = ppc.transferStateChangeId OR tscOut.transferStateChangeId = ppc.transferStateChangeId)\n  AND ( tp.createdDate BETWEEN STR_TO_DATE(:startDate, '%Y-%m-%dT%T') AND STR_TO_DATE(:endDate, '%Y-%m-%dT%T'))\n  ORDER BY p.name, pc.currencyId, pc.participantCurrencyId, tp.createdDate) AS result\nWHERE result.status != 'ABORTED'\n"
  template: |
    <!DOCTYPE html>

    <html lang="en">

    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            td, th {
    //            border: 1px solid #efefef;
                text-align: left;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title> DFSP Settlement Statement</title>
    </head>

    <body>


    <%


    const formatAmount = (amount) => {
      if(amount){
        return parseFloat(amount).toLocaleString('en-US',
          { minimumFractionDigits: report[0]?.currencyScale });
      } else {
        return '';
      }
    }

    %>


    <% dfspInfo.forEach(element => { // Loop Through all the currency accounts
        const reportData = report.filter( record => record.participantId === element.participantId && record.currencyId === element.currencyId && record.participantCurrencyId === element.participantCurrencyId);
    %>


        <table name=<%= `${element?.name}-${element?.currencyId}` %>>
            <tr>
                <th><span>DFSP </span></th>
                <td style="text-align: left"><%= element?.name %></td>
            </tr>
            <tr>
                <th><span>Account Type</span></th>
                <td style="text-align: left"><%= element?.accountType %></td>
            </tr>
            <tr>
                <th><span>Date From</span></th>
                <td style="text-align: left"><%= element?.startDate %></td>
            </tr>
            <tr>
                <th><span>Date To</span></th>
                <td style="text-align: left"><%= element?.endDate %></td>
            </tr>
            <tr>
                <th><span>Currency</span></th>
                <td style="text-align: left"><%= element?.currencyId %></td>
            </tr>

            <tr><td></td><td></td></tr>

            <tr>
                <th>Transfer Id</th>
                <th>Date Time</th>
                <th>Process Description</th>
                <th>Funds In</th>
                <th>Funds Out</th>
                <th>Balance</th>
            </tr>
            <% for (const { name, currencyId, transferId, createdDate, description, fundsIn, fundsOut, balance } of reportData) { %>
                <tr>
                    <td><%= `${transferId}` %></td>
                    <td style="text-align: right"><%= createdDate && (d = createdDate, `${d.toLocaleDateString('en-ZA')} ${d.toLocaleTimeString('en-US')}`)%></td>
                    <td><%= `${description}` %></td>
                    <td style="text-align: right"><%= formatAmount(fundsIn) %></td>
                    <td style="text-align: right"><%= formatAmount(fundsOut) %></td>
                    <td style="text-align: right"><%= formatAmount(balance) %></td>
                </tr>
            <% } %>
        </table>

        <br /><br />

    <% }) %>
    </body>

    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-reconciliation-amount
spec:
  permission: report-reconciliation-amount
  endpoint:
    path: /reconciliationAmount
    params:
      - name: settlementWindowId
        required: true
      - name: dfspId
        required: true
  queries:
    - name: report
      query: |
        SELECT
          fromName,
          fromId,
          toName,
          toId,
          currency,
          numTransactions,
          TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM sent)) AS sent,
          TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM received)) AS received,
          TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM net)) AS net,
          settlementWindowOpen,
          settlementWindowClose
        FROM (
          SELECT
            payer.name AS fromName,
            payer.participantId AS fromId,
            payee.name AS toName,
            payee.participantId AS toId,
            pcPayer.currencyId AS currency,
            COUNT(txpPayer.transferId) AS numTransactions,
            CASE WHEN payer.participantId = :dfspId THEN sum(txpPayer.amount) ELSE 0 END AS sent,
            CASE WHEN payer.participantId = :dfspId THEN 0 ELSE sum(txpPayer.amount) END AS received,
            CASE WHEN payer.participantId = :dfspId THEN -sum(txpPayer.amount) ELSE sum(txpPayer.amount) END AS net,
            swOpen.createdDate AS settlementWindowOpen,
            swClose.createdDate AS settlementWindowClose
          FROM
            transferParticipant txpPayer
          INNER JOIN
            transferParticipant txpPayee
            ON txpPayer.transferId = txpPayee.transferId
            AND txpPayer.transferParticipantId != txpPayee.transferParticipantId
          INNER JOIN
            transferFulfilment txf
            ON txf.transferId = txpPayer.transferId
          INNER JOIN
            transferParticipantRoleType txprt
            ON txprt.transferParticipantRoleTypeId = txpPayer.transferParticipantRoleTypeId
            AND txprt.name = 'PAYER_DFSP'
          INNER JOIN
            participantCurrency pcPayer
            ON pcPayer.participantCurrencyId = txpPayer.participantCurrencyId
          INNER JOIN
            participantCurrency pcPayee
            ON pcPayee.participantCurrencyId = txpPayee.participantCurrencyId
          INNER JOIN
            participant payer
            ON pcPayer.participantId = payer.participantId
          INNER JOIN
            participant payee
            ON pcPayee.participantId = payee.participantId
          INNER JOIN
            settlementWindow sw
            ON sw.settlementWindowId = txf.settlementWindowId
          INNER JOIN
            settlementWindowStateChange swOpen
            ON swOpen.settlementWindowId = sw.settlementWindowId
          INNER JOIN
            settlementWindowStateChange swClose
            ON swClose.settlementWindowId = sw.settlementWindowId
          WHERE
            sw.settlementWindowId = :settlementWindowId
            AND swOpen.settlementWindowStateId = 'OPEN'
            AND swClose.settlementWindowStateId = 'CLOSED'
            AND (payer.participantId = :dfspId OR payee.participantId = :dfspId)
          GROUP BY
            payer.participantId,
            payee.participantId,
            currency,
            swOpen.createdDate,
            swClose.createdDate
        ) AS result
  template: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th {
            //            border: 1px solid #efefef;
                text-align: left;
                padding: 0 8px;
            }

            td {
    //            border: 1px solid #efefef;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title>FSP Settlement Report</title>
    </head>
    <body>

    <%
        const formatAmount = (amount) => parseFloat(amount).toLocaleString('en-US');
    %>

    <table>
        <tr>
            <td>fromName</td>
            <td>fromId</td>
            <td>toName</td>
            <td>toId</td>
            <td>currency</td>
            <td>numTransactions</td>
            <td>sent</td>
            <td>received</td>
            <td>net</td>
            <td>settlementWindowOpen</td>
            <td>settlementWindowClose</td>
        </tr>
        <% for(let e of report) { %>
            <tr>
                <td><%= e.fromName %></td>
                <td><%= e.fromId %></td>
                <td><%= e.toName %></td>
                <td><%= e.toId %></td>
                <td><%= e.currency %></td>
                <td><%= e.numTransactions %></td>
                <td><%= e.sent %></td>
                <td><%= e.received %></td>
                <td><%= e.net %></td>
                <td><%= e.settlementWindowOpen.toISOString() %></td>
                <td><%= e.settlementWindowClose.toISOString() %></td>
            </tr>
        <% } %>
    </table>
    </body>
    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-settlement
spec:
  permission: report-settlement
  endpoint:
    path: /settlement
    params:
      - name: settlementId
        required: true
      - name: currency
  queries:
    - name: settlementId
      query: SELECT :settlementId
    - name: transfers
      query: |
        SELECT
            p2.name as sender,
            p2.participantId as senderId,
            receiverId,
            SUM(amount) as amount,
            settlementId,
            ss.createdDate,
            MAX(lastActionDate) as lastActionDate,
            currencyId,
            MAX(currencyScale) as currencyScale
          FROM
              participant p2 LEFT JOIN
              (
                  SELECT settlementId,
                         createdDate,
                         MAX(lastActionDate) as lastActionDate,
                         senderId,
                         receiverId,
                         SUM(amount)         as amount,
                         currencyId,
                         MAX(currencyScale) as currencyScale
                  FROM (
                           SELECT MAX(CASE WHEN tP.amount > 0 THEN p.participantId END) as senderId,
                                  MAX(CASE WHEN tP.amount < 0 THEN p.participantId END) as receiverId,
                                  MAX(tP.amount)                               as amount,
                                  MAX(tF.completedDate)                        as lastActionDate,
                                  s.settlementId,
                                  s.createdDate,
                                  c.currencyId as currencyId,
                                  MAX(c.scale) as currencyScale
                           FROM transferParticipant tP
                                    INNER JOIN transferFulfilment tF on tP.transferId = tF.transferId
                                    INNER JOIN settlementSettlementWindow sSW
                                               on tF.settlementWindowId = sSW.settlementWindowId
                                    INNER JOIN settlementWindowStateChange sWSC
                                               on sSW.settlementWindowId = sWSC.settlementWindowId
                                    INNER JOIN settlement s on sSW.settlementId = s.settlementId
                                    INNER JOIN participantCurrency pC
                                               on tP.participantCurrencyId = pC.participantCurrencyId
                                    INNER JOIN currency c on c.currencyId = pC.currencyId
                                    INNER JOIN participant p on pC.participantId = p.participantId
                           WHERE tF.isValid
                             AND sWSC.settlementWindowStateId = 'CLOSED'
                             AND s.settlementId = :settlementId
                             AND CASE WHEN :currency IS NOT NULL THEN c.currencyId = :currency ELSE TRUE END
                           GROUP BY tF.transferId, s.settlementId, c.currencyId
                       ) s
                  GROUP BY senderId, receiverId, settlementId, currencyId
              ) ss ON p2.participantId = ss.senderId

          WHERE p2.name != 'Hub'
          GROUP BY settlementId, p2.participantId, receiverId, currencyId
          ORDER BY settlementId DESC, p2.name
  template: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            td, th {
    //            border: 1px solid #efefef;
                text-align: left;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title>Settlement Bank Report</title>
    </head>
    <body>

    <%
    const senders = [];
    const receivers = [];
    const amounts = {};
    const totalSent = {};
    const totalReceived = {};
    const participants = {};
    let netTotal = 0;
    const netPositionsPretty = {};
    const defaultCurrency = transfers[0]?.currencyId;
    for (let t of transfers) {
        participants[t.senderId] = t.sender;
        if (!senders.includes(t.senderId)) {
            senders.push(t.senderId);
        }
        if (t.receiverId && t.currencyId === defaultCurrency) {
            amounts[`${t.senderId}:${t.receiverId}`] = parseFloat(t.amount);
            totalSent[t.senderId] = (totalSent[t.senderId] || 0) + parseFloat(t.amount);
            totalReceived[t.receiverId] = (totalReceived[t.receiverId] || 0) + parseFloat(t.amount);
            if (!receivers.includes(t.receiverId)) {
                receivers.push(t.receiverId);
            }
        }
    }
    const participantEntries = Object.entries(participants).sort((a, b) => a[1].localeCompare(b[1]));

    const formatAmount = (amount) => {
          const v = parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: transfers[0]?.currencyScale });
          return `${v} ${transfers[0]?.currencyId}`;
    }

    for(let [id] of participantEntries) {
        let v = ((totalSent[id] || 0) - (totalReceived[id] || 0));
        netTotal += v;
        let vf = Math.abs(v).toLocaleString('en-US', { minimumFractionDigits: transfers[0]?.currencyScale });
        netPositionsPretty[id] = v >= 0 ? `${vf} ${transfers[0]?.currencyId}` : `(${vf}) ${transfers[0]?.currencyId}`;
    }

    const lastActionDate = transfers.reduce((a,b) => a.lastActionDate?.getTime() > b.lastActionDate?.getTime() ? a : b, 0)?.lastActionDate;

    const jsonOutput = {
      settlementId: transfers[0]?.settlementId,
      currency: transfers[0]?.currencyId,
      createdDate:transfers[0]?.createdDate,
      lastActionDate,
      totalSent: participantEntries
                  .reduce((acc, [id, name]) => Object.assign(acc, { [name]: totalSent[id] || 0 }), {}),
      totalReceived,
      netPositions: netPositionsPretty,
      participants: participantEntries,
    };
    %>

    <table data-json="<%= JSON.stringify(transfers) %>" >
        <tr>
            <td><span>Settlement ID</span></td>
            <td style="text-align: right"><%= transfers[0]?.settlementId %></td>
            <td></td>
            <td><span>Created Date</span></td>
            <td colspan="2" style="text-align: right"><%= transfers[0]?.createdDate && (d = transfers[0].createdDate, `${d.toLocaleDateString('en-ZA')} ${d.toLocaleTimeString('en-US')}`)%></td>
        </tr>
        <tr>
            <td><span>Currency</span></td>
            <td style="text-align: right"><%= transfers[0]?.currencyId %></td>
            <td></td>
            <td><span>Last Action Date</span></td>
            <td colspan="2" style="text-align: right"><%=
                `${lastActionDate?.toLocaleDateString('en-ZA')} ${lastActionDate?.toLocaleTimeString('en-US')}`
                %></td>
        </tr>
        <tr>
            <td colspan="100%" style="padding-top: 20px"><div style="font-weight: bold">Multilateral Net Positions</div></td>
        </tr>
        <tr>
            <th></th>
            <th></th>
            <% for(let i = 0; i < participantEntries.length; i++) { %>
            <th><span>Received by</span></th>
            <% } %>
            <th>TOTAL SENT</th>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <% for(let [id, name] of participantEntries) { %>
                <td><%= `${id} ${name}` %></td>
            <% } %>
            <td></td>
        </tr>
        <% for(let [senderId, senderName] of participantEntries) { %>
            <tr>
                <td><span>Sent by</span></td>
                <td><%= `${senderId} ${senderName}` %></td>
                <% for(let [receiverId] of participantEntries) { %>
                    <% if (senderId === receiverId) { %>
                        <td style="background-color: #cccccc"></td>
                    <% } else if (amounts[`${senderId}:${receiverId}`]) { %>
                        <td style="text-align: right"><%= formatAmount(amounts[`${senderId}:${receiverId}`]) %></td>
                    <% } else { %>
                        <td style="text-align: right">-</td>
                    <% } %>
                <% } %>
                <td style="text-align: right"><%= totalSent[senderId] ? formatAmount(totalSent[senderId]) : '-' %></td>
            </tr>
        <% } %>
        <tr>
            <td colspan="100%" style="padding-top: 10px"></td>
        </tr>
        <tr>
            <td></td>
            <td><span>Total Received</span></td>
            <% for(let [id] of participantEntries) { %>
                <td style="text-align: right"><%= totalReceived[id] ? totalReceived[id].toLocaleString('en-US') : '-' %></td>
            <% } %>
        </tr>
        <tr>
            <td colspan="100%" style="padding-top: 30px"><div style="font-weight: bold">Aggregated Net Positions</div></td>
        </tr>
        <% for(let [id, name] of participantEntries) { %>
            <tr>
                <td><%= `${id} ${name}` %></td>
                <td style="text-align: right"><%= netPositionsPretty[id] %></td>
                <td></td>
            </tr>
        <% } %>
        <tr>
            <td style="padding-top: 30px">Check value</td>
            <td style="text-align: right"><%= netTotal %></td>
            <td>(should be zero)</td>
        </tr>
    </table>
    </body>
    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-settlement-audit
spec:
  permission: report-settlement-audit
  endpoint:
    path: /settlementAudit
    params:
      - name: startDate
        required: true
      - name: endDate
        required: true
  queries:
    - name: dfspInfo
      query: "SELECT \n    p.participantId, \n    p.name, \n    :startDate AS startDate, \n    :endDate AS endDate,\n    pc.currencyId,\n    pc.participantCurrencyId,\n    lat.name AS accountType\nFROM participant p\nINNER JOIN participantCurrency pc on pc.participantId = p.participantId\nINNER JOIN ledgerAccountType lat on lat.ledgerAccountTypeId = pc.ledgerAccountTypeId\nWHERE p.name != 'Hub' AND lat.name = 'SETTLEMENT'\n"
    - name: report
      query: "SELECT\n    p.participantId AS participantId,\n    p.name AS name,\n    pc.currencyId AS currencyId,\n    pc.participantCurrencyId AS participantCurrencyId,\n    tp.transferId AS transferId, \n    tp.createdDate AS createdDate,\n    COALESCE(tscIn.transferStateChangeId, tscOut.transferStateChangeId) as transferStateChangeId,\n    (CASE WHEN COALESCE(tsIn.enumeration, tsOut.enumeration) != 'ABORTED' THEN 'SUCCESS' ELSE tsOut.enumeration END) AS status,\n    COALESCE(tscIn.reason, tscOut.reason) AS description,\n    COALESCE(tex1.value, '') AS user,\n    COALESCE(tex2.value, '') AS reference,\n    (CASE WHEN tp.amount < 0 THEN -tp.amount ELSE NULL END) AS fundsIn,\n    (CASE WHEN tp.amount > 0 THEN tp.amount ELSE NULL END) AS fundsOut,\n    ppc.value AS balance,\n    c.scale AS  currencyScale,\n    lat.name AS accountType\nFROM participant p \nINNER JOIN participantCurrency pc ON p.participantId = pc.participantId \nINNER JOIN ledgerAccountType lat ON lat.ledgerAccountTypeId = pc.ledgerAccountTypeId\nINNER JOIN transferParticipant tp ON tp.participantCurrencyId = pc.participantCurrencyId\nINNER JOIN transferParticipantRoleType tpr ON tpr.transferParticipantRoleTypeId = tp.transferParticipantRoleTypeId\nLEFT JOIN transferStateChange tscOut ON tp.transferId = tscOut.transferId AND tscOut.transferStateChangeId = (SELECT MAX(transferStateChangeId) FROM transferStateChange tscOut1 WHERE tscOut1.transferId = tp.transferId\nAND tscOut1.transferStateId in ('RESERVED', 'ABORTED_REJECTED'))\nLEFT JOIN transferState tsOut ON tscOut.transferStateId = tsOut.transferStateId       \nLEFT JOIN transferStateChange tscIn ON tp.transferId = tscIn.transferId AND tscIn.transferStateChangeId = (SELECT MAX(transferStateChangeId) FROM transferStateChange tscIn1 WHERE tscIn1.transferId = tp.transferId\nAND tscIn1.transferStateId in ('COMMITTED', 'ABORTED_REJECTED'))\nLEFT JOIN transferState tsIn ON tscIn.transferStateId = tsIn.transferStateId   \nINNER JOIN participantPosition pp ON pp.participantCurrencyId = pc.participantCurrencyId\nINNER JOIN participantPositionChange ppc ON ppc.participantPositionId = pp.participantPositionId\nINNER JOIN currency c ON c.currencyId = pc.currencyId\nLEFT JOIN transferExtension tex1 ON tex1.transferId = tp.transferId AND tex1.key = 'user'\nLEFT JOIN transferExtension tex2 ON tex2.transferId = tp.transferId AND tex2.key = 'externalReference'\n\nWHERE tpr.name = 'DFSP_SETTLEMENT'\nAND (tscIn.transferStateChangeId = ppc.transferStateChangeId OR tscOut.transferStateChangeId = ppc.transferStateChangeId)\nAND tex1.transferExtensionId = (SELECT MAX(transferExtensionId) FROM transferExtension tex1u WHERE tex1u.transferId = tp.transferId AND tex1u.key = 'user')\nAND tex2.transferExtensionId = (SELECT MAX(transferExtensionId) FROM transferExtension tex2u WHERE tex2u.transferId = tp.transferId AND tex2u.key = 'externalReference')\nAND ( tp.createdDate BETWEEN STR_TO_DATE(:startDate, '%Y-%m-%dT%T') AND STR_TO_DATE(:endDate, '%Y-%m-%dT%T'))\nORDER BY p.name, pc.currencyId, pc.participantCurrencyId,  tp.createdDate\n"
  template: |
    <!DOCTYPE html>

    <html lang="en">

    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            td, th {
    //            border: 1px solid #efefef;
                text-align: left;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title> DFSP Settlement Statement</title>
    </head>

    <body>


    <%


    const formatAmount = (amount) => {
      if(amount){
        return parseFloat(amount).toLocaleString('en-US',
          { minimumFractionDigits: report[0]?.currencyScale });
      } else {
        return '';
      }
    }

    %>


    <% dfspInfo.forEach(element => { // Loop Through all the currency accounts
        const reportData = report.filter( record => record.participantId === element.participantId && record.currencyId === element.currencyId && record.participantCurrencyId === element.participantCurrencyId);
    %>


        <table name=<%= `${element?.name}-${element?.currencyId}` %>>
            <tr>
                <th><span>DFSP </span></th>
                <td style="text-align: left"><%= element?.name %></td>
            </tr>
            <tr>
                <th><span>Account Type</span></th>
                <td style="text-align: left"><%= element?.accountType %></td>
            </tr>
            <tr>
                <th><span>Date From</span></th>
                <td style="text-align: left"><%= element?.startDate %></td>
            </tr>
            <tr>
                <th><span>Date To</span></th>
                <td style="text-align: left"><%= element?.endDate %></td>
            </tr>
            <tr>
                <th><span>Currency</span></th>
                <td style="text-align: left"><%= element?.currencyId %></td>
            </tr>

            <tr><td></td><td></td></tr>

            <tr>
                <th>Transfer Id</th>
                <th>Date Time</th>
                <th>Transfer Status</th>
                <th>Process Description</th>
                <th>User</th>
                <th>Reference</th>
                <th>Funds In</th>
                <th>Funds Out</th>
                <th>Balance</th>
            </tr>
            <% for (const { name, currencyId, transferId, createdDate, status, description, user, reference, fundsIn, fundsOut, balance } of reportData) { %>
                <tr>
                    <td><%= `${transferId}` %></td>
                    <td style="text-align: right"><%= createdDate && (d = createdDate, `${d.toLocaleDateString('en-ZA')} ${d.toLocaleTimeString('en-US')}`)%></td>
                    <td><%= `${status}` %></td>
                    <td><%= `${description}` %></td>
                    <td><%= `${user}` %></td>
                    <td><%= `${reference}` %></td>
                    <td style="text-align: right"><%= formatAmount(fundsIn) %></td>
                    <td style="text-align: right"><%= formatAmount(fundsOut) %></td>
                    <td style="text-align: right"><%= formatAmount(balance) %></td>
                </tr>
            <% } %>
        </table>

        <br /><br />

    <% }) %>
    </body>

    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-settlement-initiation
spec:
  permission: report-settlement-initiation
  endpoint:
    path: /settlementInitiation
    params:
      - name: settlementId
        required: true
  queries:
    - name: settlementId
      query: SELECT :settlementId AS settlementId
    - name: adjustments
      query: |
        SELECT
            SUM(tp.amount)            AS  amount,
            p.name                    AS  name,
            p.participantId           AS  participantId,
            pc.participantCurrencyId  AS  accountId,
            pc.currencyId             AS  currencyId,
            MAX(c.scale)              AS  currencyScale
        FROM settlement s
        INNER JOIN settlementSettlementWindow ssw  ON  ssw.settlementId = s.settlementId
        INNER JOIN transferFulfilment tf           ON  tf.settlementWindowId = ssw.settlementWindowId
        INNER JOIN transferParticipant tp          ON  tp.transferId = tf.transferId
        INNER JOIN participantCurrency pc          ON  tp.participantCurrencyId = pc.participantCurrencyId
        INNER JOIN currency c                      ON  c.currencyId = pc.currencyId
        INNER JOIN participant p                   ON  p.participantId = pc.participantId
        INNER JOIN ledgerAccountType lat           ON  lat.ledgerAccountTypeId = pc.ledgerAccountTypeId
        WHERE s.settlementId = :settlementId AND lat.name = 'POSITION'
        GROUP BY p.name, pc.participantCurrencyId
  template: "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <style>\n        table {\n            font-family: Calibri;\n            font-size: 11pt;\n            border-collapse: collapse;\n            width: 100%;\n            display: block;\n            overflow-x: auto;\n            white-space: nowrap;\n        }\n        td, th {\n            border: 1px solid black;\n            text-align: left;\n            padding: 8px;\n        }\n\n        tr:nth-child(even) {\n//            background-color: #efefef;\n        }\n\n        td > span {\n            font-weight: bold;\n        }\n        tr.noborder td {\n            border: none;\n        }\n    </style>\n    <title>Settlement Bank Report</title>\n</head>\n<body>\n\n<%\nconst bankId = {\n    demomfi: 'demomfi placeholder\\n0000 0000 0000 0000',\n    demowallet: 'demowallet placeholder\\n0000 0000 0000 0000',\n    noresponsepayeefsp: 'noresponsepayeefsp placeholder\\n0000 0000 0000 0000',\n    payeefsp: 'payeefsp placeholder\\n0000 0000 0000 0000',\n    payerfsp: 'payerfsp placeholder\\n0000 0000 0000 0000',\n    pm4mlreceiverfsp: 'pm4mlreceiverfsp placeholder\\n0000 0000 0000 0000',\n    pm4mlsenderfsp: 'pm4mlsenderfsp placeholder\\n0000 0000 0000 0000',\n    testfsp1: 'testfsp1 placeholder\\n0000 0000 0000 0000',\n    testfsp2: 'testfsp2 placeholder\\n0000 0000 0000 0000',\n};\n\nconst formatAmount = (amount) => parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: adjustments[0]?.currencyScale });\n\n// Because no currency has more than four decimal places, we can have quite a large epsilon value\nconst EPSILON = 1e-5;\n// We use parseFloat because it returns NaN for parseFloat(null)\nconst transfersSum = adjustments.reduce((sum, adj) => sum + parseFloat(adj.amount), 0);\nif (Number.isNaN(transfersSum) || (transfersSum > EPSILON)) {\n  throw new Error(`Expected settlement initiation report transfers to sum to zero. Sum: ${transfersSum}. Report data: ${JSON.stringify(adjustments)}.`);\n}\n%>\n\n<table data-sheet-name=\"SettlementBankReport\">\n    <tr> \n        <td><span>Settlement ID</span></td>\n        <td style=\"text-align: right\"><%= settlementId[0].settlementId %></td>\n    </tr>\n    <tr>\n        <td><span>Settlement Completed Date</span></td>\n        <td style=\"text-align: right\"></td>\n    </tr>\n    <tr>\n        <td><span>Settlement Completed Time</span></td>\n        <td style=\"text-align: right\"></td>\n    </tr>\n    <tr>\n        <td><span>Timezone</span></td>\n        <td style=\"text-align: right\">MMT</td>\n    </tr>\n    <tr class = \"noborder\">\n        <td colspan=\"100%\" style=\"padding-top: 20px\"></td>\n    </tr>\n    <tr>\n        <td>Participant (PayerFSP Identifier)</td>\n        <td>Participant (Bank Identifier)</td>\n        <td>Balance</td>\n        <td>Settlement Transfer</td>\n        <td>Currency</td>\n    </tr>\n    <% for (const { name, participantId, accountId, currencyId, amount } of adjustments) { %>\n        <tr>\n            <td><%= `${participantId} ${accountId} ${name}` %></td>\n            <td><%= `${bankId[name]}` %></td>\n            <td></td>\n            <td style=\"text-align: right\"><%= formatAmount(amount) %></td>\n            <td><%= `${currencyId}` %></td>\n        </tr>\n    <% } %>\n</table>\n</body>\n</html>\n"
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-settlement-window
spec:
  permission: report-settlement-window
  endpoint:
    path: /settlementWindow
  queries:
    - name: report
      query: |
        SELECT sq.*, swOpen.createdDate AS windowOpen, swClose.createdDate as windowClose
        FROM
          (
              SELECT
                  qp.fspId,
                  sw.settlementWindowId,
                  swsc.settlementWindowStateId AS state,
                  COUNT(qp.amount) AS numTransactions,
                  SUM(qp.amount) AS netPosition
              FROM
                  central_ledger.settlementWindow AS sw
              LEFT JOIN
                   central_ledger.transferFulfilment AS tf
                   ON tf.settlementWindowId = sw.settlementWindowId
              LEFT JOIN
                   central_ledger.transactionReference AS tr
                   ON tf.transferId = tr.transactionReferenceId
              INNER JOIN
                   central_ledger.transferParticipant AS tp
                   ON tp.transferId = tf.transferId
              INNER JOIN
                   central_ledger.transferParticipantRoleType AS trpt
                   ON trpt.transferParticipantRoleTypeId = tp.transferParticipantRoleTypeId
              INNER JOIN
                   central_ledger.settlementWindowStateChange AS swsc
                   ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
              LEFT JOIN
                   central_ledger.quoteParty AS qp
                   ON qp.quoteId = tr.quoteId AND qp.transferParticipantRoleTypeId = tp.transferParticipantRoleTypeId
              GROUP BY qp.fspId, sw.settlementWindowId
          ) AS sq
        INNER JOIN
          central_ledger.settlementWindowStateChange AS swOpen
          ON swOpen.settlementWindowId = sq.settlementWindowId
        LEFT OUTER JOIN
          central_ledger.settlementWindowStateChange AS swClose
          ON swClose.settlementWindowId = sq.settlementWindowId AND swClose.settlementWindowStateId = 'CLOSED'
        WHERE
        swOpen.settlementWindowStateId = 'OPEN'
  template: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th {
            //            border: 1px solid #efefef;
                text-align: left;
                padding: 0 8px;
            }

            td {
    //            border: 1px solid #efefef;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title>FSP Settlement Report</title>
    </head>
    <body>

    <%
        const formatAmount = (amount) => parseFloat(amount).toLocaleString('en-US');
    %>

    <table>
            <tr>
                <td>fspId</td>
                <td>settlementWindowId</td>
                <td>state</td>
                <td>numTransactions</td>
                <td>netPosition</td>
                <td>windowOpen</td>
            </tr>
            <% for(let e of report) { %>
                <tr>
                    <td><%= e.fspId %></td>
                    <td><%= e.settlementWindowId %></td>
                    <td><%= e.state %></td>
                    <td><%= e.numTransactions %></td>
                    <td><%= e.netPosition %></td>
                    <td><%= e.windowOpen.toISOString() %></td>
                </tr>
            <% } %>
        </table>
    </body>
    </html>
---
apiVersion: mojaloop.io/v1
kind: MojaloopReport
metadata:
  name: release-name-tx-reconciliation
spec:
  permission: report-tx-reconciliation
  endpoint:
    path: /transactionReconciliation
    params:
      - name: settlementWindowId
      - name: dfspId
        required: true
      - name: startDate
        required: true
      - name: endDate
        required: true
  queries:
    - name: report
      query: |
        SELECT DISTINCT
          qt.quoteId AS quoteId,
          payerPart.name AS senderDFSPId,
          payerPart.name AS senderDFSPName,
          payeeQp.fspId AS receiverDFSPId,
          payeePart.name AS receiverDFSPName,
          tfr.transferId AS hubTxnID,
          IF(txnSce.name = 'TRANSFER', 'P2P', (IF(txnSce.name = 'TRANSFER', 'MP', NULL))) AS transactionType,
          IF(qt.transactionRequestId IS NULL, 'Original', 'Reversal') AS natureOfTxnType,
          qt.createdDate AS requestDate,
          tfr.createdDate AS createdDate,
          IF(ssc.settlementStateId = 'SETTLED', ssc.createdDate, Cast(NULL as datetime)) AS settlementDate,
          payerQp.currencyId AS senderCountryCurrencyCode,
          payeeQp.currencyId AS receiverCountryCurrencyCode,
          payerQp.partyIdentifierValue AS senderId,
          payeeQp.partyIdentifierValue AS receiverId,
          tfr.amount AS reconciliationAmount,
          IF((payeeParty.firstName <> NULL && payeeParty.lastName <> NULL), 'RNR', 'RNND') AS receiverNameStatus,
          '' AS pricingOption,
          '' AS receiverKYCLevelStatus,
          ts.transferStateId AS status,
          ts.createdDate as modificationDate, '' AS errorCode,
          tfr.transferId AS senderDFSPTxnID,
          tfr.transferId AS receiverDFSPTxnID,
          IF(xfrFul.settlementWindowId IS NULL, '', Cast(xfrFul.settlementWindowId as char)) AS settlementWindowId,
          ssc.settlementStateId AS settlementState,
          ssc.createdDate AS settlementStateChangeDate
        FROM
          quote qt
        INNER JOIN
          transactionReference txnref
          ON qt.quoteId = txnref.quoteId
        INNER JOIN
          transactionScenario txnSce
          ON qt.transactionScenarioId = txnSce.transactionScenarioId
        INNER JOIN
          quoteParty payerQp
          ON qt.quoteId = payerQp.quoteId AND payerQp.partyTypeId = '1'
        INNER JOIN
          quoteParty payeeQp
          ON qt.quoteId = payeeQp.quoteId AND payeeQp.partyTypeId = '2'
        INNER JOIN
          participant payerPart
          ON payerQp.participantId = payerPart.participantId
        INNER JOIN
          participant payeePart
          ON payeeQp.participantId = payeePart.participantId
        INNER JOIN
          quoteResponse qr
          ON qr.quoteId = qt.quoteId
        INNER JOIN
          transfer tfr
          ON tfr.transferId = txnref.transactionReferenceId
        LEFT JOIN
          transferFulfilment xfrFul
          ON xfrFul.transferId = tfr.transferId
        LEFT JOIN
          party payerParty
          ON payerQp.partyTypeId = payerParty.partyId
        LEFT JOIN
          party payeeParty
          ON payerQp.partyTypeId = payeeParty.partyId
        LEFT JOIN
          settlementSettlementWindow ssw
          ON ssw.settlementWindowId = xfrFul.settlementWindowId
        LEFT JOIN
          settlement sett
          ON sett.settlementId = ssw.settlementId
        LEFT JOIN
          settlementStateChange ssc
          ON ssc.settlementStateChangeId = sett.currentStateChangeId
        LEFT JOIN
          (
              SELECT tsc.transferId, tsc.transferStateId, tsc.createdDate
              FROM
                  transferStateChange tsc
              INNER JOIN
                  (
                      SELECT
                          MAX(tsc.transferStateChangeId) AS transferStateChangeId,
                          tsc.transferId
                      FROM
                          transferStateChange tsc
                      GROUP BY transferId
                  ) mtsc
                  ON mtsc.transferId = tsc.transferId AND tsc.transferStateChangeId = mtsc.transferStateChangeID
          ) ts
          ON ts.transferId = tfr.transferId
        WHERE
          (payerPart.name = :dfspId OR payeePart.name = :dfspId)
        AND
          (xfrFul.settlementWindowId = :settlementWindowId OR :settlementWindowId IS NULL)
        AND
          qt.createdDate BETWEEN STR_TO_DATE(:startDate, '%Y-%m-%dT%T') AND STR_TO_DATE(:endDate, '%Y-%m-%dT%T')
  template: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            th {
            //            border: 1px solid #efefef;
                text-align: left;
                padding: 0 8px;
            }

            td {
    //            border: 1px solid #efefef;
                padding: 8px;
            }

            tr:nth-child(even) {
    //            background-color: #efefef;
            }

            td > span {
                font-weight: bold;
            }
        </style>
        <title>FSP Settlement Report</title>
    </head>
    <body>

    <%
        const formatAmount = (amount) => parseFloat(amount).toLocaleString('en-US');
    %>

    <table>
            <tr>
                <% for(let k of Object.keys(report[0] || {})) { %>
                  <td><%= k %></td>
                <% } %>
            </tr>

            <% for(let r of report) { %>
            <tr>
              <% for(let k of Object.keys(r)) { %>

                    <td><%= r[k] %></td>
              <% } %>
            </tr>
            <% } %>

        </table>
    </body>
    </html>
