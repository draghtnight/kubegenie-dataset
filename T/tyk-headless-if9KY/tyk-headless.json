[
  {
    "apiVersion": "v1",
    "kind": "Secret",
    "metadata": {
      "name": "release-name-default-cert"
    },
    "type": "Opaque",
    "data": {
      "cert.pem": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM2ekNDQWRPZ0F3SUJBZ0lKQU9lU09URWVSTVBFTUEwR0NTcUdTSWIzRFFFQkN3VUFNQXd4Q2pBSUJnTlYKQkFNTUFTb3dIaGNOTWpFd016QTRNVGN6TmpRMldoY05Nall3TXpBM01UY3pOalEyV2pBTU1Rb3dDQVlEVlFRRApEQUVxTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF5SHhsd21KZGQwaFU3YVAvClRaUDJ2bEM5UlFpbS8zdGhZc0xpbkhyeStnREdIaUZqOW5uMlIza1BreTB0MHg0RWRlU1pkb1RYQXNyaDZjdzAKbzJuTlJXNW5CV0xiK3Z2ZTA1ZG9Hc2I0TnkzdWhGM1FTT1ovZEVLdGpQdzdkMlB5anZqbG9YOHBtQ0QyN3NkVwpNSEUreGEvbVc5TlZhZGgrdzdOT3loS2RWWnp0M0U3MmFWOTlEZXl0cng3Smw1YkNFZld0bk5pU0p5a1pjQkZwCjFsb3ZiZUNiOVlxcDRDcGptdm9OSnVFR1dJeHBScGliUlVoMUtLNVloVEFncGZYODQ5M3MvdFVma1grWE5BUUEKdnJBWWdFN0lDc21KdmRueThFTXZZaEoyd2JuUHpMSE5KNXFPemNJaGtjWTAvc2l4bUxNVFRFRmdYbzJNT09XVQpnZXN4Q1FJREFRQUJvMUF3VGpBZEJnTlZIUTRFRmdRVUlLZXpUY3dGZW82U1NRMHNtUXZtMDVjdDBHRXdId1lEClZSMGpCQmd3Rm9BVUlLZXpUY3dGZW82U1NRMHNtUXZtMDVjdDBHRXdEQVlEVlIwVEJBVXdBd0VCL3pBTkJna3EKaGtpRzl3MEJBUXNGQUFPQ0FRRUFDTll2S2JNQk9VeTJ1SjNvaEZjODNFOWtoSjdUMlJoWk9lZE02bmxidk5xWgpIcmFOcXMweWQzalBZRmZXTzlaT2xyZmNQZ1FDS2pyMlhHR2hmczBOZm9HSm1mbDVuai9QeDRGSHBsb095cnV5Ci9YVjFsKzlpS0x2NFRVcis3dGpaUVhHaUdKSC8yN2d5SW1MVWNWcm80ZnJDOG1ZRlBRSHdCaVJtblRzOUlSYXEKY3doNHNlQ2x3aktxUWY5NGxkNTNtM2ZHdEJlY21LSmliUG1TcVIzVWczdlZKYm5WYW1jMjhXZ20wVXUzT1lHOApXOXBzSlhyNHh4clZGQmMydTU0TEVjM1V3NXFWcEpwcHNxMXRFb0VrUEZGd3lmM0gvVTdxSng4N3Y1OG9pS2ltCmVyUUdCT0Vtemowd3g0RExRM3dDUlNWc0diWWg0UEFNSHBSRUNiTFpOZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K",
      "key.pem": "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRElmR1hDWWwxM1NGVHQKby85TmsvYStVTDFGQ0tiL2UyRml3dUtjZXZMNkFNWWVJV1AyZWZaSGVRK1RMUzNUSGdSMTVKbDJoTmNDeXVIcAp6RFNqYWMxRmJtY0ZZdHY2Kzk3VGwyZ2F4dmczTGU2RVhkQkk1bjkwUXEyTS9EdDNZL0tPK09XaGZ5bVlJUGJ1CngxWXdjVDdGcitaYjAxVnAySDdEczA3S0VwMVZuTzNjVHZacFgzME43SzJ2SHNtWGxzSVI5YTJjMkpJbktSbHcKRVduV1dpOXQ0SnYxaXFuZ0ttT2ErZzBtNFFaWWpHbEdtSnRGU0hVb3JsaUZNQ0NsOWZ6ajNleisxUitSZjVjMApCQUMrc0JpQVRzZ0t5WW05MmZMd1F5OWlFbmJCdWMvTXNjMG5tbzdOd2lHUnhqVCt5TEdZc3hOTVFXQmVqWXc0CjVaU0I2ekVKQWdNQkFBRUNnZ0VCQUlkWVM0NHR2N0Z1T0Q5eHprRytHUDRrSFpKRUpCRW5admc0WHFtSzZ3dFIKaUc0QTFxNG5hZGFZYUtaUUFyYWFkaUpzb0JsOTFuVkJKOEFoSm93SE9oZWNUNW80UWcrdkI1L0tmL0pMem5mWgozMEttM3B6SVZ0VFN5cno1N3Q5THJ3MU1CQ0hCYWdBVWlQOXJ2TWpaT3FwVWRHd2JRSGRETzFpOGJQMUlFY1VnCkNLV0hIMGl6K2g2TEpBek9wOFh1YUVhci9kV2hDbnFhMDZ4c1NBMmowV3JXZ0FBR0U0TmV0QjhiazkwTGpYQzEKaCtMYnEzYnFtbHBOYWtzNFV4RzIvQXR2TTZJakI1cGRLdmx3SGJMTkFxM0l6SEVEZDlidW53TmpIMy9WVkJVZQpQaTV5MVN6eGZqMjNWK2treFZYRG0ydjU2dmdlYmFacFNqY0ZjUlBFSlUwQ2dZRUE3K1FFRlZlaisydTZFK1NnCnd5QkNya3IrTWRIZ1ZKcHRqTk1VR2hyREQyWnZSbWVvdFIyak1Pa3ZlcnNoYXo2K21KTkN0cGE0UjlUaUxxNHUKMXd3dFcrZ25MYUg0bkRBSlNubk9aaDJDYnkxeWVFVWNwd3NxTmF4MmhmWCs1SUdvaTArVmtzZnk5WVoxZitzLwo1ZE9pbWZCcFk2RjJhWGN1bER0UER5TmVZOE1DZ1lFQTFmTDRjeDdUUGhVSkR0aTlXNkZVWUg4UFMvZFNZNk1BCmhQeE02OS9oM1k4VC8xMklVWTBPYk5GM2dzYnhXT1N1U0Z1QTBFc3F3U2tCQVc1VUlKSURNc3N4NXJJUFNmSEIKS20zTlA2YzdnVTB4Yi9CYTVVUEhld016aExid2pEbG1XNmlXZjdxSStocWdWTlJwU0dQSTR3WEJybWZTSEo2TgpPZGo4ZmJhRVIwTUNnWUE1M1FZZkg4U3VJSTRCdm1RSXJQOW9peTVGVmhxR1RibWUva3NiQU5tTUhXazUwa2NmCmFNYTBSWXJ1VDdULzZXS1A2dlZzbFc1ZDVUdXBodHBGaE9wc0FOTnlibDlKVFV6d2FmRWZNSDhGMGpDS1VpRlgKS1pwRTJCUyt1MWVBUnNZZzFGRi8xanNFZmlwWmNLVTVDcE51RGs5ZGVOVFhHNmhnbU8yNCtROExnUUtCZ1FERQpBZEllWGFvNElUdG9MNmJqY0owRnZzSTczWHpNcllRSFVjSURBdHhCaUJoUkJ0YWhwL0lFUGE4WXo3eENyVmNDCkVWcWsrWWhVNklUMFU2aWRJa2Z0Mi94K2xyaXRETi9rU0M0VzE5WUxNclpORUUybDV2KzFNZ3liMUtIeVJaQUIKL3lUS0poSGgyRXoxQ3BqZDZoVWI3NlV1YkEweGpReGpaK2lDSDVsMlV3S0JnRzBoaFdHcjRLOVU0RlkyenZCQwpPYkJ1QkhZcy9wQVhHVmsxVHo1R0NNOTNuTXB5eUR3cG1ZbEltMVI2LzVKcmhwcitDOHF2WXk3dnh0NFRMTmkrCjY4Y0ZRaStZVU9YTGd0QjZtNnkwWUQxemlYOU5wNFhTSDdoSVovcUFKYTFLQkQ5dGU2TnNUdmY4dHR4N01JSkYKRnA0MWQ4NkhEYTd5Wmk2NStUWExRTU5yCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K"
    }
  },
  {
    "apiVersion": "v1",
    "kind": "Secret",
    "metadata": {
      "name": "secrets-release-name-tyk-headless",
      "labels": {
        "app": "secrets-data-release-name-tyk-headless",
        "chart": "release-name-tyk-headless",
        "release": "release-name",
        "heritage": "Helm"
      }
    },
    "type": "Opaque",
    "stringData": {
      "redisPass": "",
      "redisSentinelPass": "",
      "mongoURL": "mongodb://mongo.default.svc.cluster.local:27017/tyk_analytics",
      "APISecret": "CHANGEME"
    }
  },
  {
    "apiVersion": "v1",
    "kind": "ConfigMap",
    "metadata": {
      "name": "mgmt-gateway-conf-release-name-tyk-headless",
      "labels": {
        "app": "gateway-release-name-tyk-headless",
        "chart": "tyk-headless-0.9.5",
        "release": "release-name",
        "heritage": "Helm"
      }
    },
    "data": {
      "tyk_mgmt.conf": "{\n    \"listen_port\": 8080,\n    \"secret\": \"$sharedsecret\",\n    \"node_secret\": \"$sharedsecret\",\n    \"template_path\": \"/opt/tyk-gateway/templates\",\n    \"tyk_js_path\": \"/opt/tyk-gateway/js/tyk.js\",\n    \"middleware_path\": \"/mnt/tyk-gateway/middleware\",\n    \"use_db_app_configs\": false,\n    \"db_app_conf_options\": {\n        \"connection_string\": \"\",\n        \"node_is_segmented\": false,\n        \"tags\": []\n    },\n    \"app_path\": \"/mnt/tyk-gateway/apps\",\n    \"storage\": {\n        \"type\": \"redis\",\n        \"enable_cluster\": false,\n        \"hosts\": {\n            \"$redis\": \"$rport\"\n        },\n        \"username\": \"\",\n        \"password\": \"\",\n        \"database\": 0,\n        \"optimisation_max_idle\": 1000\n    },\n    \"enable_analytics\": false,\n    \"analytics_config\": {\n        \"type\": \"mongo\",\n        \"csv_dir\": \"/tmp\",\n        \"mongo_url\": \"\",\n        \"mongo_db_name\": \"\",\n        \"mongo_collection\": \"\",\n        \"purge_delay\": -1,\n        \"ignored_ips\": []\n    },\n    \"health_check\": {\n        \"enable_health_checks\": false,\n        \"health_check_value_timeouts\": 60\n    },\n    \"optimisations_use_async_session_write\": true,\n    \"enable_non_transactional_rate_limiter\": true,\n    \"enable_sentinel_rate_limiter\": false,\n    \"allow_master_keys\": false,\n    \"policies\": {\n        \"policy_source\": \"file\",\n        \"policy_record_name\": \"/mnt/tyk-gateway/policies/policies.json\"\n    },\n    \"hash_keys\": true,\n    \"hash_key_function\": \"murmur128\",\n    \"close_connections\": false,\n    \"http_server_options\": {\n        \"enable_websockets\": true,\n        \"use_ssl\": true,\n        \"server_name\": \"*\",\n        \"min_version\": 771,\n        \"certificates\": [{\n            \"domain_name\": \"*\",\n            \"cert_file\": \"/etc/certs/cert.pem\",\n            \"key_file\": \"/etc/certs/key.pem\"\n        }]\n    },\n    \"allow_insecure_configs\": true,\n    \"coprocess_options\": {\n        \"enable_coprocess\": true,\n        \"coprocess_grpc_server\": \"\"\n    },\n    \"enable_bundle_downloader\": false,\n    \"bundle_base_url\": \"\",\n    \"global_session_lifetime\": 100,\n    \"force_global_session_lifetime\": false,\n    \"max_idle_connections_per_host\": 500,\n    \"enable_custom_domains\": true,\n    \"pid_file_location\": \"/mnt/tyk-gateway/tyk.pid\"\n}\n"
    }
  },
  {
    "apiVersion": "v1",
    "kind": "Service",
    "metadata": {
      "name": "gateway-svc-release-name-tyk-headless",
      "labels": {
        "app": "gateway-svc-release-name-tyk-headless",
        "chart": "tyk-headless-0.9.5",
        "release": "release-name",
        "heritage": "Helm"
      }
    },
    "spec": {
      "type": "NodePort",
      "ports": [
        {
          "port": 443,
          "targetPort": 8080,
          "protocol": "TCP"
        }
      ],
      "selector": {
        "app": "gateway-release-name-tyk-headless",
        "release": "release-name"
      }
    }
  },
  {
    "apiVersion": "apps/v1",
    "kind": "DaemonSet",
    "metadata": {
      "name": "gateway-release-name-tyk-headless",
      "labels": {
        "app": "gateway-release-name-tyk-headless",
        "chart": "tyk-headless-0.9.5",
        "release": "release-name",
        "heritage": "Helm"
      }
    },
    "spec": {
      "minReadySeconds": 5,
      "updateStrategy": {
        "type": "RollingUpdate",
        "rollingUpdate": {
          "maxUnavailable": 1
        }
      },
      "selector": {
        "matchLabels": {
          "app": "gateway-release-name-tyk-headless",
          "release": "release-name"
        }
      },
      "template": {
        "metadata": {
          "labels": {
            "app": "gateway-release-name-tyk-headless",
            "release": "release-name"
          },
          "annotations": {
            "checksum/config": "4e3a6ffb4a30e4afa20d34022cb502ea14dc83067197d82a3a6114bb78cad4f9"
          }
        },
        "spec": {
          "tolerations": [
            {
              "effect": "NoSchedule",
              "key": "node-role.kubernetes.io/master"
            }
          ],
          "initContainers": [
            {
              "name": "setup-directories",
              "image": "busybox:1.32",
              "command": [
                "sh",
                "-c",
                "mkdir -p apps middleware policies && touch policies/policies.json"
              ],
              "workingDir": "/mnt/tyk-gateway",
              "volumeMounts": [
                {
                  "name": "tyk-scratch",
                  "mountPath": "/mnt/tyk-gateway"
                }
              ]
            }
          ],
          "containers": [
            {
              "name": "gateway-tyk-headless",
              "image": "docker.tyk.io/tyk-gateway/tyk-gateway:v3.2.1",
              "imagePullPolicy": "IfNotPresent",
              "securityContext": {
                "runAsNonRoot": true,
                "allowPrivilegeEscalation": false,
                "privileged": false,
                "readOnlyRootFilesystem": true,
                "capabilities": {
                  "drop": [
                    "all"
                  ]
                }
              },
              "env": [
                {
                  "name": "TYK_GW_LISTENPORT",
                  "value": "8080"
                },
                {
                  "name": "REDIGOCLUSTER_SHARDCOUNT",
                  "value": "128"
                },
                {
                  "name": "TYK_GW_STORAGE_ADDRS",
                  "value": "redis.default.svc.cluster.local:6379"
                },
                {
                  "name": "TYK_GW_STORAGE_MASTERNAME",
                  "value": ""
                },
                {
                  "name": "TYK_GW_STORAGE_ENABLECLUSTER",
                  "value": "false"
                },
                {
                  "name": "TYK_GW_STORAGE_DATABASE",
                  "value": "0"
                },
                {
                  "name": "TYK_GW_STORAGE_PASSWORD",
                  "valueFrom": {
                    "secretKeyRef": {
                      "name": "secrets-release-name-tyk-headless",
                      "key": "redisPass"
                    }
                  }
                },
                {
                  "name": "TYK_GW_STORAGE_USESSL",
                  "value": "false"
                },
                {
                  "name": "TYK_GW_SECRET",
                  "valueFrom": {
                    "secretKeyRef": {
                      "name": "secrets-release-name-tyk-headless",
                      "key": "APISecret"
                    }
                  }
                },
                {
                  "name": "TYK_GW_NODESECRET",
                  "valueFrom": {
                    "secretKeyRef": {
                      "name": "secrets-release-name-tyk-headless",
                      "key": "APISecret"
                    }
                  }
                },
                {
                  "name": "TYK_GW_HTTPSERVEROPTIONS_USESSL",
                  "value": "false"
                }
              ],
              "command": [
                "/opt/tyk-gateway/tyk",
                "--conf=/etc/tyk-gateway/tyk.conf"
              ],
              "workingDir": "/opt/tyk-gateway",
              "ports": [
                {
                  "containerPort": 8080
                }
              ],
              "resources": {
                "seccompProfile": {
                  "type": "RuntimeDefault"
                }
              },
              "volumeMounts": [
                {
                  "name": "tyk-mgmt-gateway-conf",
                  "mountPath": "/etc/tyk-gateway"
                },
                {
                  "name": "release-name-default-cert",
                  "mountPath": "/etc/certs"
                },
                {
                  "name": "tyk-scratch",
                  "mountPath": "/mnt/tyk-gateway"
                }
              ],
              "livenessProbe": {
                "httpGet": {
                  "scheme": "HTTP",
                  "path": "/hello",
                  "port": 8080
                },
                "initialDelaySeconds": 5,
                "periodSeconds": 2,
                "timeoutSeconds": 3,
                "failureThreshold": 2
              },
              "readinessProbe": {
                "httpGet": {
                  "scheme": "HTTP",
                  "path": "/hello",
                  "port": 8080
                },
                "initialDelaySeconds": 1,
                "periodSeconds": 10,
                "timeoutSeconds": 3,
                "failureThreshold": 3
              }
            }
          ],
          "securityContext": {
            "runAsUser": 1000,
            "fsGroup": 2000
          },
          "volumes": [
            {
              "name": "tyk-scratch",
              "emptyDir": {}
            },
            {
              "name": "tyk-mgmt-gateway-conf",
              "configMap": {
                "name": "mgmt-gateway-conf-release-name-tyk-headless",
                "items": [
                  {
                    "key": "tyk_mgmt.conf",
                    "path": "tyk.conf"
                  }
                ]
              }
            },
            {
              "name": "release-name-default-cert",
              "secret": {
                "secretName": "release-name-default-cert"
              }
            }
          ]
        }
      }
    }
  }
]