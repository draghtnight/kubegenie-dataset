apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-mongo
  namespace: UbiYfT9qXxqwT
  labels:
    app.kubernetes.io/name: mongo
    helm.sh/chart: mongo-11.1.10
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
secrets:
  - name: release-name-mongo
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-default
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-default
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-configuration-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-configuration-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-shipyard-controller
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-shipyard-controller
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-secret-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-secret-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-lighthouse-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-lighthouse-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-api-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-api-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keptn-webhook-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-api-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
---
apiVersion: v1
kind: Secret
metadata:
  name: keptn-api-token
  labels:
    app.kubernetes.io/name: keptn-api-token
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
type: Opaque
data:
  keptn-api-token: MncySUZDelpmeXNGMjdaRmU3T1lkVVNmYVVZTldPZFNzWFdDTUZDcnlia3NP
---
apiVersion: v1
kind: Secret
metadata:
  name: bridge-credentials
  labels:
    app.kubernetes.io/name: bridge-credentials
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
type: Opaque
data:
  BASIC_AUTH_USERNAME: a2VwdG4=
  BASIC_AUTH_PASSWORD: SDZOdnZWdHB2R2dqQVVrRTVNbXM=
---
apiVersion: v1
kind: Secret
metadata:
  name: bridge-oauth
  labels:
    app.kubernetes.io/name: bridge-oauth
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
type: Opaque
data:
  session_secret: dmRGMHhLTmFQU0NsV1hSbUEwODhRNXcyN2FaZmVrSUQwNWtEWERpelNjMVZ2
  database_encrypt_secret: alhVV29pcWx2dHFaOVJ4T0tlUWwwQlJhVzdCUUdTMTA=
---
apiVersion: v1
kind: Secret
metadata:
  name: bridge-oauth-mongodb-credentials
  labels:
    app.kubernetes.io/name: bridge-oauth-mongodb-credentials
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
type: Opaque
data:
  external_connection_string: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-credentials
  labels:
    app.kubernetes.io/name: mongodb-credentials
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
type: Opaque
data:
  mongodb-user: a2VwdG4=
  mongodb-passwords: Rm92d25ickwwUUFkd3I3d2JRQWY=
  mongodb-root-user: YWRtaW4=
  mongodb-root-password: VlpCYnZhaXEwVmtSWWlRMlJqeFNhR1E2VDd4QmNkbzhEVExuUzI4Z3ltVURM
  external_connection_string: ""
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keptn-nats-config
  namespace: UbiYfT9qXxqwT
  labels:
    helm.sh/chart: nats-0.13.2
    app.kubernetes.io/name: keptn-nats
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 2.7.3
    app.kubernetes.io/managed-by: Helm
data:
  nats.conf: |
    # NATS Clients Port
    port: 4222

    # PID file shared with configuration reloader.
    pid_file: "/var/run/nats/nats.pid"

    ###############
    #             #
    # Monitoring  #
    #             #
    ###############
    http: 8222
    server_name:$POD_NAME
    ###################################
    #                                 #
    # NATS JetStream                  #
    #                                 #
    ###################################
    jetstream {
      max_mem: 2Gi
      store_dir: /data/

      max_file:5Gi
    }
    lame_duck_duration: 120s
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-nginx-config
  labels:
    app.kubernetes.io/name: api-nginx-config-cm
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
data:
  nginx.conf: |
    worker_processes  3;
    pid /tmp/nginx.pid;
    error_log /dev/stdout info;
    events {
      worker_connections  10240;
    }

    http {
      log_format  main
              'remote_addr:$remote_addr\t'
              'time_local:$time_local\t'
              'method:$request_method\t'
              'uri:$request_uri\t'
              'host:$host\t'
              'status:$status\t'
              'bytes_sent:$body_bytes_sent\t'
              'referer:$http_referer\t'
              'useragent:$http_user_agent\t'
              'forwardedfor:$http_x_forwarded_for\t'
              'request_time:$request_time';
      access_log /dev/stdout;
      # rewrite_log on;
      absolute_redirect off;

      # remove nginx version
      server_tokens off;

      # https://www.nginx.com/blog/websocket-nginx/
      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }

      map $http_x_forwarded_proto $forward_proto {
        default $scheme;
        https https;
      }

      server {
          listen       8080;
          server_name  _;
            client_max_body_size 5m;

          include /etc/nginx/keptn-endpoints-pre-0-7.conf;
          include /etc/nginx/keptn-endpoints.conf;
      }
    }
  keptn-endpoints.conf: |
    rewrite ^/$ /bridge/ permanent;
    rewrite ^/api$ /api/swagger-ui/ permanent;

    # special configuration for /v1/auth to always use POST requests
    location /api/v1/auth {
      rewrite /api/v1/auth /v1/auth break;

      proxy_method POST;
      proxy_pass_request_body off;
      proxy_pass http://api-service:8080;
      proxy_http_version 1.1;
      proxy_pass_request_headers on; # only pass request headers to this service
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /bridge {
      rewrite /bridge(/.*) $1 break;
      proxy_pass http://bridge:8080;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $forward_proto;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
      proxy_buffer_size 128k;
      proxy_buffers 4 256k;
      proxy_busy_buffers_size 256k;
    }

    # health check
    location /nginx-health {
        access_log off;
        return 200 "OK\n";
    }

    location /api/mongodb-datastore/swagger-ui/swagger.yaml {
     # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
     # the access is denied) before we store the file
     # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      rewrite /api/mongodb-datastore/(.*) /$1  break;
      proxy_pass         http://mongodb-datastore:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # block writing calls to /api/mongodb-datastore/event
    location = /api/mongodb-datastore/event {
      limit_except GET HEAD OPTIONS {
        deny all;
      }
      auth_request               /api/v1/auth;
      rewrite /api/mongodb-datastore/(.*) /$1  break;
      proxy_pass         http://mongodb-datastore:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # block all calls to /api/mongodb-datastore/health
    location = /api/mongodb-datastore/health {
      deny all;
    }

    location /api/mongodb-datastore {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      auth_request               /api/v1/auth;

      rewrite /api/mongodb-datastore/(.*) /$1  break;
      proxy_pass         http://mongodb-datastore:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/controlPlane/swagger-ui/swagger.yaml {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.

      rewrite /api/controlPlane/(.*) /$1  break;
      proxy_pass         http://shipyard-controller:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # block DELETE calls to /api/controlplane/v1/log
    location /api/controlPlane/v1/log {
      limit_except GET POST PUT PATCH OPTIONS HEAD {
        deny all;
      }
      auth_request               /api/v1/auth;

      rewrite /api/controlPlane/(.*) /$1  break;
      proxy_pass         http://shipyard-controller:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location  /api/controlPlane {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      auth_request               /api/v1/auth;

      rewrite /api/controlPlane/(.*) /$1  break;
      proxy_pass         http://shipyard-controller:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/secrets/swagger-ui/swagger.yaml {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.

      rewrite /api/secrets/(.*) /$1  break;
      proxy_pass         http://secret-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location  /api/secrets/ {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      auth_request               /api/v1/auth;

      rewrite /api/secrets/(.*) /$1  break;
      proxy_pass         http://secret-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/statistics/swagger-ui/swagger.yaml {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.

      rewrite /api/statistics/(.*) /$1  break;
      proxy_pass         http://statistics-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # block all calls to /api/statistics/v1/event
    location ~* /api/statistics/v1/event {
      deny all;
    }

    location  /api/statistics {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      auth_request               /api/v1/auth;

      rewrite /api/statistics/(.*) /$1  break;
      proxy_pass         http://statistics-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/configuration-service/swagger-ui/swagger.yaml {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.

      rewrite /api/configuration-service/(.*) /$1  break;
      proxy_pass         http://configuration-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # block /api/configuration-service/v1/project/*
    location ~* /api/configuration-service/v1/project/([^/]*)/service/([^/]*)/resource/([^/]*)$ {
      deny all;
    }

    # block /api/configuration-service/v1/project/*
    location ~* /api/configuration-service/v1/project/([^/]*)/service/([^/]*)/resource$ {
      deny all;
    }

    # block all calls to /project/*/stage/*/service/*
    location ~* /api/configuration-service/v1/project/([^/]*)/stage/([^/]*)/service/([^/]*)$ {
      deny all;
    }

    # block all calls to /project/*/stage/*/service
    location ~* /api/configuration-service/v1/project/([^/]*)/stage/([^/]*)/service$ {
      deny all;
    }

    # block all calls to /project/*/stage/*
    location ~* /api/configuration-service/v1/project/([^/]*)/stage/([^/]*)$ {
      deny all;
    }

    # block all calls to /project/*/stage
    location ~* /api/configuration-service/v1/project/([^/]*)/stage$ {
      deny all;
    }

    # block all calls to /project/*
    location ~* /api/configuration-service/v1/project/([^/]*)$ {
      deny all;
    }

    # block all calls to /project
    location = /api/configuration-service/v1/project {
      deny all;
    }

    location /api/configuration-service/  {
      # auth via backend (if the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403,
      # the access is denied) before we store the file
      # see http://nginx.org/en/docs/http/ngx_http_auth_request_module.html
      auth_request               /api/v1/auth;

      rewrite /api/configuration-service/(.*) /$1  break;
      proxy_pass         http://configuration-service:8080;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api {
      rewrite /api/(.*) /$1 break;
      rewrite /api / break;
      proxy_pass http://api-service:8080;
      proxy_http_version 1.1;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
    }
  keptn-endpoints-pre-0-7.conf: |
    rewrite ^/project/(.*) /bridge/project/$1 permanent;
    rewrite ^/trace/(.*) /bridge/trace/$1 permanent;
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-service-config
  labels:
    app.kubernetes.io/name: secret-service-config-cm
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
data:
  scopes.yaml: |
    Scopes:
      keptn-default:
        Capabilities:
          keptn-secrets-default-read:
            Permissions:
              - get
      keptn-webhook-service:
        Capabilities:
          keptn-webhook-svc-read:
            Permissions:
              - get
      dynatrace-service:
        Capabilities:
          keptn-dynatrace-svc-read:
            Permissions:
              - get
      keptn-prometheus-service:
        Capabilities:
          keptn-prometheus-svc-read:
            Permissions:
              - get
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keptn-webhook-config
  labels:
    app.kubernetes.io/name: webhook-service-config
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
data:
  denyList: |-
    kubernetes
    kubernetes.default
    kubernetes.default.svc
    kubernetes.default.svc.cluster.local
    svc.cluster.local
    cluster.local
    localhost
    127.0.0.1
    ::1
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: release-name-mongo
  namespace: default
  labels:
    app.kubernetes.io/name: mongo
    helm.sh/chart: mongo-11.1.10
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: mongodb
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 8Gi
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-manage-secrets
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-manage-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - create
      - get
      - delete
      - update
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-get-secrets
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-get-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-manage-roles
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-manage-roles
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - roles
    verbs:
      - create
      - get
      - delete
      - update
      - deletecollection
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-manage-rolebindings
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-manage-rolebindings
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - rolebindings
    verbs:
      - create
      - get
      - delete
      - update
      - deletecollection
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-read-metadata
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-read-metadata
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - extensions
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-manage-configmaps
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-manage-configmaps
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - create
      - update
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-get-webhook-config
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-get-webhook-config
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    resourceNames:
      - keptn-webhook-config
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-delete-bridge-pod
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-delete-bridge-pod
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - delete
      - deletecollection
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keptn-acquire-lease
  labels:
    app.kubernetes.io/name: keptn-acquire-lease
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
rules:
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    resourceNames:
      - shipyard-controller-dispatcher
    verbs:
      - get
      - update
      - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-lighthouse-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-lighthouse-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-manage-configmaps
subjects:
  - kind: ServiceAccount
    name: keptn-lighthouse-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-webhook-service
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-webhook-service
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-get-webhook-config
subjects:
  - kind: ServiceAccount
    name: keptn-webhook-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-api-service-metadata
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-api-service-metadata
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-read-metadata
subjects:
  - kind: ServiceAccount
    name: keptn-api-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-configuration-service-get-secrets
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-configuration-service-get-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-get-secrets
subjects:
  - kind: ServiceAccount
    name: keptn-configuration-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-shipyard-controller-manage-secrets
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-shipyard-controller-manage-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-manage-secrets
subjects:
  - kind: ServiceAccount
    name: keptn-shipyard-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-secret-service-manage-secrets
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-secret-service-manage-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-manage-secrets
subjects:
  - kind: ServiceAccount
    name: keptn-secret-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-secret-service-manage-roles
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-secret-service-manage-roles
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-manage-roles
subjects:
  - kind: ServiceAccount
    name: keptn-secret-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-secret-service-manage-rolebindings
  labels:
    helm.sh/chart: control-plane-0.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 0.16.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keptn-secret-service-manage-secrets
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-manage-rolebindings
subjects:
  - kind: ServiceAccount
    name: keptn-secret-service
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keptn-shipyard-controller-acquire-lease
  labels:
    app.kubernetes.io/name: keptn-shipyard-controller-acquire-lease
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keptn-acquire-lease
subjects:
  - kind: ServiceAccount
    name: keptn-shipyard-controller
---
apiVersion: v1
kind: Service
metadata:
  name: release-name-mongo
  namespace: UbiYfT9qXxqwT
  labels:
    app.kubernetes.io/name: mongo
    helm.sh/chart: mongo-11.1.10
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: mongodb
spec:
  type: ClusterIP
  ports:
    - name: mongodb
      port: 27017
      targetPort: mongodb
      nodePort: null
  selector:
    app.kubernetes.io/name: mongo
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/component: mongodb
---
apiVersion: v1
kind: Service
metadata:
  name: keptn-nats
  namespace: UbiYfT9qXxqwT
  labels:
    helm.sh/chart: nats-0.13.2
    app.kubernetes.io/name: keptn-nats
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 2.7.3
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    app.kubernetes.io/name: keptn-nats
    app.kubernetes.io/instance: release-name
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: client
      port: 4222
    - name: cluster
      port: 6222
    - name: monitor
      port: 8222
    - name: metrics
      port: 7777
    - name: leafnodes
      port: 7422
    - name: gateways
      port: 7522
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway-nginx
  labels:
    app.kubernetes.io/name: api-gateway-nginx
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  type: ClusterIP
  ports:
    - port: 80
      name: http
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: api-gateway-nginx
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  labels:
    app.kubernetes.io/name: api-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      name: http
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: api-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: approval-service
  labels:
    app.kubernetes.io/name: approval-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: approval-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: bridge
  labels:
    app.kubernetes.io/name: bridge
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 3000
      protocol: TCP
  selector:
    app.kubernetes.io/name: bridge
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: configuration-service
  labels:
    app.kubernetes.io/name: configuration-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: resource-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: remediation-service
  labels:
    app.kubernetes.io/name: remediation-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: remediation-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-datastore
  labels:
    app.kubernetes.io/name: mongodb-datastore
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: mongodb-datastore
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: lighthouse-service
  labels:
    app.kubernetes.io/name: lighthouse-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: lighthouse-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: secret-service
  labels:
    app.kubernetes.io/name: secret-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: secret-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: shipyard-controller
  labels:
    app.kubernetes.io/name: shipyard-controller
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: shipyard-controller
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: statistics-service
  labels:
    app.kubernetes.io/name: statistics-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: statistics-service
    app.kubernetes.io/instance: release-name
---
apiVersion: v1
kind: Service
metadata:
  name: webhook-service
  labels:
    app.kubernetes.io/name: webhook-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    helm.sh/chart: control-plane-0.1.0
spec:
  ports:
    - port: 8080
      protocol: TCP
  selector:
    app.kubernetes.io/name: webhook-service
    app.kubernetes.io/instance: release-name
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-mongo
  namespace: UbiYfT9qXxqwT
  labels:
    app.kubernetes.io/name: mongo
    helm.sh/chart: mongo-11.1.10
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: mongodb
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: mongo
      app.kubernetes.io/instance: release-name
      app.kubernetes.io/component: mongodb
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mongo
        helm.sh/chart: mongo-11.1.10
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: mongodb
    spec:
      serviceAccountName: release-name-mongo
      affinity:
        podAffinity: null
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: mongo
                    app.kubernetes.io/instance: release-name
                    app.kubernetes.io/component: mongodb
                namespaces:
                  - default
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity: null
      securityContext:
        fsGroup: 1001
        sysctls: []
      containers:
        - name: mongodb
          image: docker.io/bitnami/mongodb:4.4.13-debian-10-r52
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsNonRoot: true
            runAsUser: 10816
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                "": NET_RAW
            readOnlyRootFilesystem: true
          env:
            - name: BITNAMI_DEBUG
              value: "false"
            - name: MONGODB_EXTRA_USERNAMES
              value: keptn
            - name: MONGODB_EXTRA_DATABASES
              value: keptn
            - name: MONGODB_EXTRA_PASSWORDS
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-passwords
            - name: MONGODB_ROOT_USER
              value: admin
            - name: MONGODB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-root-password
            - name: ALLOW_EMPTY_PASSWORD
              value: "no"
            - name: MONGODB_SYSTEM_LOG_VERBOSITY
              value: "0"
            - name: MONGODB_DISABLE_SYSTEM_LOG
              value: "no"
            - name: MONGODB_DISABLE_JAVASCRIPT
              value: "no"
            - name: MONGODB_ENABLE_JOURNAL
              value: "yes"
            - name: MONGODB_ENABLE_IPV6
              value: "no"
            - name: MONGODB_ENABLE_DIRECTORY_PER_DB
              value: "no"
          ports:
            - name: mongodb
              containerPort: 27017
          livenessProbe:
            exec:
              command:
                - mongo
                - --disableImplicitSessions
                - --eval
                - db.adminCommand('ping')
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
                - bash
                - -ec
                - |
                  # Run the proper check depending on the version
                  [[ $(mongo --version | grep "MongoDB shell") =~ ([0-9]+\.[0-9]+\.[0-9]+) ]] && VERSION=${BASH_REMATCH[1]}
                  . /opt/bitnami/scripts/libversion.sh
                  VERSION_MAJOR="$(get_sematic_version "$VERSION" 1)"
                  VERSION_MINOR="$(get_sematic_version "$VERSION" 2)"
                  VERSION_PATCH="$(get_sematic_version "$VERSION" 3)"
                  if [[ "$VERSION_MAJOR" -ge 4 ]] && [[ "$VERSION_MINOR" -ge 4 ]] && [[ "$VERSION_PATCH" -ge 2 ]]; then
                      mongo --disableImplicitSessions $TLS_OPTIONS --eval 'db.hello().isWritablePrimary || db.hello().secondary' | grep -q 'true'
                  else
                      mongo --disableImplicitSessions $TLS_OPTIONS --eval 'db.isMaster().ismaster || db.isMaster().secondary' | grep -q 'true'
                  fi
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          resources:
            limits: {}
            requests: {}
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            - name: datadir
              mountPath: /bitnami/mongodb
              subPath: null
      volumes:
        - name: datadir
          persistentVolumeClaim:
            claimName: release-name-mongo
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway-nginx
  labels:
    app.kubernetes.io/name: api-gateway-nginx
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 1.22.0-alpine
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: api-gateway-nginx
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: api-gateway-nginx
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 1.22.0-alpine
        helm.sh/chart: control-plane-0.1.0
      annotations:
        rollme: TSwEI
    spec:
      securityContext:
        fsGroup: 101
        seccompProfile:
          type: RuntimeDefault
      terminationGracePeriodSeconds: 60
      containers:
        - name: api-gateway-nginx
          image: docker.io/nginxinc/nginx-unprivileged:1.22.0-alpine
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - sleep 20; /usr/local/openresty/nginx/sbin/nginx -c /etc/nginx/nginx.conf -s quit; while pgrep -x nginx; do sleep 1; done
          ports:
            - containerPort: 8080
          livenessProbe:
            httpGet:
              path: /nginx-health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /nginx-health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          volumeMounts:
            - mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
              readOnly: true
              name: api-nginx-config
            - mountPath: /etc/nginx/keptn-endpoints.conf
              subPath: keptn-endpoints.conf
              readOnly: true
              name: api-nginx-config
            - mountPath: /etc/nginx/keptn-endpoints-pre-0-7.conf
              subPath: keptn-endpoints-pre-0-7.conf
              readOnly: true
              name: api-nginx-config
            - mountPath: /etc/nginx/keptn-endpoints-pre-1-0.conf
              subPath: keptn-endpoints-pre-1-0.conf
              readOnly: true
              name: api-nginx-config
          resources:
            requests:
              memory: 64Mi
              cpu: 50m
            limits:
              memory: 128Mi
              cpu: 100m
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11359
            capabilities:
              drop:
                "": NET_RAW
      volumes:
        - name: api-nginx-config
          configMap:
            name: api-nginx-config
      serviceAccountName: keptn-default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-service
  labels:
    app.kubernetes.io/name: api-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: api-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: api-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      terminationGracePeriodSeconds: 60
      containers:
        - name: api-service
          image: docker.io/keptn/api:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "5"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 50m
            limits:
              memory: 64Mi
              cpu: 100m
          env:
            - name: PREFIX_PATH
              value: ""
            - name: EVENTBROKER_URI
              value: http://localhost:8081/event
            - name: DATASTORE_URI
              value: mongodb-datastore:8080
            - name: CONFIGURATION_URI
              value: configuration-service:8080
            - name: SECRET_TOKEN
              valueFrom:
                secretKeyRef:
                  name: keptn-api-token
                  key: keptn-api-token
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: AUTOMATIC_PROVISIONING_URL
              value: null
            - name: MAX_AUTH_ENABLED
              value: "true"
            - name: MAX_AUTH_REQUESTS_PER_SECOND
              value: "1.0"
            - name: MAX_AUTH_REQUESTS_BURST
              value: "2"
            - name: LOG_LEVEL
              value: info
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10791
            capabilities:
              drop:
                "": NET_RAW
      serviceAccountName: keptn-api-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: approval-service
  labels:
    app.kubernetes.io/name: approval-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: approval-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: approval-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      terminationGracePeriodSeconds: 60
      serviceAccountName: keptn-default
      containers:
        - name: approval-service
          image: docker.io/keptn/approval-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "5"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 25m
            limits:
              memory: 128Mi
              cpu: 100m
          env:
            - name: CONFIGURATION_SERVICE
              value: http://configuration-service:8080
            - name: EVENTBROKER
              value: http://localhost:8081/event
            - name: LOG_LEVEL
              value: info
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_DEPLOYMENT_VERSION
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: K8S_DEPLOYMENT_COMPONENT
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11078
            capabilities:
              drop:
                "": NET_RAW
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: resource-service
  labels:
    app.kubernetes.io/name: resource-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: resource-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: resource-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault
      terminationGracePeriodSeconds: 60
      containers:
        - name: resource-service
          image: docker.io/keptn/resource-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
          imagePullPolicy: IfNotPresent
          env:
            - name: PREFIX_PATH
              value: ""
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: info
            - name: DIRECTORY_STAGE_STRUCTURE
              value: "false"
            - name: GIT_KEPTN_EMAIL
              value: keptn@keptn.sh
            - name: GIT_KEPTN_USER
              value: keptn
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 25m
            limits:
              memory: 256Mi
              cpu: 100m
          volumeMounts:
            - mountPath: /data/config
              name: resource-volume
          securityContext:
            runAsNonRoot: true
            runAsUser: 11995
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            privileged: false
            capabilities:
              drop:
                "": NET_RAW
      volumes:
        - name: resource-volume
          emptyDir: {}
      serviceAccountName: keptn-configuration-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: remediation-service
  labels:
    app.kubernetes.io/name: remediation-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: remediation-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: remediation-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: remediation-service
          image: docker.io/keptn/remediation-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "5"
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 64Mi
              cpu: 50m
            limits:
              memory: 1Gi
              cpu: 200m
          env:
            - name: ENVIRONMENT
              value: production
            - name: LOG_LEVEL
              value: info
            - name: PUBSUB_TOPIC
              value: sh.keptn.event.get-action.triggered
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_DEPLOYMENT_VERSION
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: K8S_DEPLOYMENT_COMPONENT
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10815
            capabilities:
              drop:
                "": NET_RAW
      serviceAccountName: keptn-default
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bridge
  labels:
    app.kubernetes.io/name: bridge
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: bridge
      app.kubernetes.io/instance: release-name
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bridge
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: bridge
          image: docker.io/keptn/bridge2:0.16.0
          imagePullPolicy: IfNotPresent
          env:
            - name: API_URL
              value: http://api-gateway-nginx/api
            - name: API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: keptn-api-token
                  key: keptn-api-token
            - name: CLI_DOWNLOAD_LINK
              value: https://github.com/keptn/keptn/releases/tag/0.16.0
            - name: INTEGRATIONS_PAGE_LINK
              value: https://get.keptn.sh/integrations.html
            - name: ENABLE_VERSION_CHECK
              value: "true"
            - name: SHOW_API_TOKEN
              value: "true"
            - name: KEPTN_INSTALLATION_TYPE
              value: QUALITY_GATES,CONTINUOUS_OPERATIONS
            - name: LOOK_AND_FEEL_URL
              value: ""
            - name: PREFIX_PATH
              value: ""
            - name: OAUTH_ENABLED
              value: "false"
            - name: OAUTH_DISCOVERY
              value: ""
            - name: OAUTH_BASE_URL
              value: ""
            - name: OAUTH_CLIENT_ID
              value: ""
            - name: OAUTH_CLIENT_SECRET
              value: ""
            - name: OAUTH_ID_TOKEN_ALG
              value: ""
            - name: OAUTH_SCOPE
              value: ""
            - name: OAUTH_NAME_PROPERTY
              value: ""
            - name: SECURE_COOKIE
              value: "false"
            - name: SESSION_TIMEOUT_MIN
              value: ""
            - name: SESSION_VALIDATING_TIMEOUT_MIN
              value: ""
            - name: TRUST_PROXY
              value: ""
            - name: MONGODB_HOST
              value: release-name-mongo:27017
            - name: MONGODB_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-user
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-passwords
            - name: MONGODB_DATABASE
              value: keptn
            - name: CONFIG_DIR
              value: /config
            - name: AUTOMATIC_PROVISIONING_MSG
              value: null
            - name: RESOURCE_SERVICE_ENABLED
              value: "true"
            - name: D3_HEATMAP_ENABLED
              value: "false"
          envFrom:
            - secretRef:
                name: bridge-credentials
                optional: true
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 64Mi
              cpu: 25m
            limits:
              memory: 256Mi
              cpu: 200m
          volumeMounts:
            - name: assets
              mountPath: /usr/src/app/dist/assets/branding
            - name: bridge-oauth
              mountPath: /config/oauth
              readOnly: true
            - name: bridge-oauth-mongodb-credentials
              mountPath: /config/oauth_mongodb
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11375
            capabilities:
              drop:
                "": NET_RAW
      serviceAccountName: keptn-default
      volumes:
        - emptyDir: {}
          name: assets
        - name: bridge-oauth
          secret:
            secretName: bridge-oauth
            defaultMode: 256
        - name: bridge-oauth-mongodb-credentials
          secret:
            secretName: bridge-oauth-mongodb-credentials
            defaultMode: 256
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-datastore
  annotations:
    fluentbit.io/exclude: "true"
  labels:
    app.kubernetes.io/name: mongodb-datastore
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: mongodb-datastore
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mongodb-datastore
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: keptn-default
      terminationGracePeriodSeconds: 60
      containers:
        - name: mongodb-datastore
          image: docker.io/keptn/mongodb-datastore:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 50m
            limits:
              memory: 512Mi
              cpu: 300m
          env:
            - name: PREFIX_PATH
              value: ""
            - name: MONGODB_HOST
              value: release-name-mongo:27017
            - name: MONGODB_DATABASE
              value: keptn
            - name: MONGODB_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-user
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-passwords
            - name: MONGODB_EXTERNAL_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: external_connection_string
                  optional: true
            - name: LOG_LEVEL
              value: info
            - name: NATS_URL
              value: nats://keptn-nats
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_DEPLOYMENT_VERSION
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: K8S_DEPLOYMENT_COMPONENT
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10685
            capabilities:
              drop:
                "": NET_RAW
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lighthouse-service
  labels:
    app.kubernetes.io/name: lighthouse-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: lighthouse-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lighthouse-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: lighthouse-service
          image: docker.io/keptn/lighthouse-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 128Mi
              cpu: 50m
            limits:
              memory: 1Gi
              cpu: 200m
          env:
            - name: EVENTBROKER
              value: http://localhost:8081/event
            - name: CONFIGURATION_SERVICE
              value: http://configuration-service:8080
            - name: MONGODB_DATASTORE
              value: mongodb-datastore:8080
            - name: ENVIRONMENT
              value: production
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: info
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_DEPLOYMENT_VERSION
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: K8S_DEPLOYMENT_COMPONENT
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10864
            capabilities:
              drop:
                "": NET_RAW
      serviceAccountName: keptn-lighthouse-service
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secret-service
  labels:
    app.kubernetes.io/name: secret-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: secret-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: secret-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: keptn-secret-service
      terminationGracePeriodSeconds: 60
      containers:
        - name: secret-service
          image: docker.io/keptn/secret-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /v1/secret
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: info
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 25m
            limits:
              memory: 64Mi
              cpu: 200m
          volumeMounts:
            - mountPath: /data
              name: secret-service-configmap-volume
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10900
            capabilities:
              drop:
                "": NET_RAW
      volumes:
        - name: secret-service-configmap-volume
          configMap:
            name: secret-service-config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shipyard-controller
  labels:
    app.kubernetes.io/name: shipyard-controller
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: shipyard-controller
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: shipyard-controller
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: keptn-shipyard-controller
      containers:
        - name: shipyard-controller
          image: docker.io/keptn/shipyard-controller:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - wget -O- http://localhost:8081/operations/v1/pre-stop
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
          imagePullPolicy: IfNotPresent
          env:
            - name: CONFIGURATION_SERVICE
              value: http://configuration-service:8080
            - name: EVENTBROKER
              value: http://localhost:8081/event
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: MONGODB_HOST
              value: release-name-mongo:27017
            - name: MONGODB_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-user
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-passwords
            - name: MONGODB_DATABASE
              value: keptn
            - name: MONGODB_EXTERNAL_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: external_connection_string
                  optional: true
            - name: KEPTN_SPEC_VERSION
              value: 0.2.4
            - name: TASK_STARTED_WAIT_DURATION
              value: 10m
            - name: UNIFORM_INTEGRATION_TTL
              value: 48h
            - name: PRE_STOP_HOOK_TIME
              value: "15"
            - name: LOG_LEVEL
              value: info
            - name: AUTOMATIC_PROVISIONING_URL
              value: null
            - name: DISABLE_LEADER_ELECTION
              value: "true"
            - name: PROJECT_NAME_MAX_SIZE
              value: "200"
            - name: SERVICE_NAME_MAX_SIZE
              value: "43"
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 50m
            limits:
              memory: 128Mi
              cpu: 100m
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11547
            capabilities:
              drop:
                "": NET_RAW
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: statistics-service
  labels:
    app.kubernetes.io/name: statistics-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: statistics-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: statistics-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: keptn-default
      containers:
        - name: statistics-service
          image: docker.io/keptn/statistics-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
          imagePullPolicy: IfNotPresent
          env:
            - name: AGGREGATION_INTERVAL_SECONDS
              value: "1800"
            - name: NEXT_GEN_EVENTS
              value: "true"
            - name: MONGODB_HOST
              value: release-name-mongo:27017
            - name: MONGODB_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-user
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongodb-passwords
            - name: MONGODB_DATABASE
              value: keptn
            - name: MONGODB_EXTERNAL_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: external_connection_string
                  optional: true
            - name: LOG_LEVEL
              value: info
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 25m
            limits:
              memory: 64Mi
              cpu: 100m
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11016
            capabilities:
              drop:
                "": NET_RAW
        - name: distributor
          image: docker.io/keptn/distributor:0.16.0
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 16Mi
              cpu: 25m
            limits:
              memory: 32Mi
              cpu: 100m
          env:
            - name: PUBSUB_TOPIC
              value: sh.keptn.>
            - name: PUBSUB_RECIPIENT
              value: 127.0.0.1
            - name: PUBSUB_RECIPIENT_PATH
              value: /v1/event
            - name: PUBSUB_URL
              value: nats://keptn-nats
            - name: VERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: DISTRIBUTOR_VERSION
              value: 0.16.0
            - name: LOCATION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: PUBSUB_GROUP
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: OAUTH_CLIENT_ID
              value: ""
            - name: OAUTH_CLIENT_SECRET
              value: ""
            - name: OAUTH_DISCOVERY
              value: ""
            - name: OAUTH_TOKEN_URL
              value: ""
            - name: OAUTH_SCOPES
              value: ""
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65532
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webhook-service
  labels:
    app.kubernetes.io/name: webhook-service
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: keptn-default
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/version: 0.16.0
    helm.sh/chart: control-plane-0.1.0
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: webhook-service
      app.kubernetes.io/instance: release-name
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: webhook-service
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/part-of: keptn-default
        app.kubernetes.io/component: control-plane
        app.kubernetes.io/version: 0.16.0
        helm.sh/chart: control-plane-0.1.0
    spec:
      securityContext:
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: keptn-webhook-service
      containers:
        - name: webhook-service
          image: docker.io/keptn/webhook-service:0.16.0
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sleep
                  - "20"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: 32Mi
              cpu: 25m
            limits:
              memory: 64Mi
              cpu: 100m
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: info
            - name: K8S_DEPLOYMENT_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: K8S_DEPLOYMENT_VERSION
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/version']
            - name: K8S_DEPLOYMENT_COMPONENT
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.labels['app.kubernetes.io/component']
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: K8S_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 11620
            capabilities:
              drop:
                "": NET_RAW
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keptn-nats
  namespace: UbiYfT9qXxqwT
  labels:
    helm.sh/chart: nats-0.13.2
    app.kubernetes.io/name: keptn-nats
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 2.7.3
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: keptn-nats
      app.kubernetes.io/instance: release-name
  replicas: 1
  serviceName: keptn-nats
  podManagementPolicy: Parallel
  template:
    metadata:
      annotations:
        prometheus.io/path: /metrics
        prometheus.io/port: "7777"
        prometheus.io/scrape: "true"
      labels:
        app.kubernetes.io/name: keptn-nats
        app.kubernetes.io/instance: release-name
    spec:
      volumes:
        - name: config-volume
          configMap:
            name: keptn-nats-config
        - name: pid
          emptyDir: {}
      shareProcessNamespace: true
      terminationGracePeriodSeconds: 120
      containers:
        - name: nats
          image: nats:2.7.3-alpine
          imagePullPolicy: IfNotPresent
          resources:
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 4222
              name: client
            - containerPort: 7422
              name: leafnodes
            - containerPort: 7522
              name: gateways
            - containerPort: 6222
              name: cluster
            - containerPort: 8222
              name: monitor
            - containerPort: 7777
              name: metrics
          command:
            - nats-server
            - --config
            - /etc/nats-config/nats.conf
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: SERVER_NAME
              value: $(POD_NAME)
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CLUSTER_ADVERTISE
              value: $(POD_NAME).keptn-nats.$(POD_NAMESPACE).svc.cluster.local
          volumeMounts:
            - name: config-volume
              mountPath: /etc/nats-config
            - name: pid
              mountPath: /var/run/nats
            - name: keptn-nats-js-pvc
              mountPath: /data/
          livenessProbe:
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 60
            successThreshold: 1
            failureThreshold: 3
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - nats-server -sl=ldm=/var/run/nats/nats.pid
        - name: metrics
          image: natsio/prometheus-nats-exporter:0.9.1
          imagePullPolicy: IfNotPresent
          resources: {}
          args:
            - -connz
            - -routez
            - -subz
            - -varz
            - -prefix=nats
            - -use_internal_server_id
            - -jsz=all
            - http://localhost:8222/
          ports:
            - containerPort: 7777
              name: metrics
  volumeClaimTemplates:
    - metadata:
        name: keptn-nats-js-pvc
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: keptn-nats-test-request-reply
  labels:
    helm.sh/chart: nats-0.13.2
    app.kubernetes.io/name: keptn-nats
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: 2.7.3
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: test
spec:
  containers:
    - name: nats-box
      image: synadia/nats-box
      env:
        - name: NATS_HOST
          value: keptn-nats
      command:
        - /bin/sh
        - -ec
        - |
          nats reply -s nats://$NATS_HOST:4222 'name.>' --command "echo 1" &
        - |
          "&&"
        - |
          name=$(nats request -s nats://$NATS_HOST:4222 name.test '' 2>/dev/null)
        - |
          "&&"
        - |
          [ $name = test ]
  restartPolicy: Never
